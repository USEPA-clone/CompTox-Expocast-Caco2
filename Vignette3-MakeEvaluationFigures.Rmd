---
title: "Honda et al. (unsubmitted): Analysis and Figure Generation"
author: "Greg Honda"
date: "August 3, 2020"
output: rmarkdown::html_vignette
vignette: >
 %\VignetteIndexEntry{Honda et al. (unsubmitted): Analysis and Figure Generation}
 %\VignetteEngine{knitr::rmarkdown}
 %\VignetteEncoding{UTF-8}
---
wambaugh.john@epa.gov

## Abstract
Apical-to-basolateral (PAB) and basolateral-to-apical (PBA) measurements were 
made in the Caco-2 assay for 484 environmental and pharmaceutical chemicals. 
After filtering, 310 chemicals had a useable PAB and 396 had a useable PBA. 
Replicates (> 30) were measured for the control chemicals Warfarin, Talinolol, 
and Ranitidine. Measurement uncertainty was high (SD: 0.3 log10 units) for the 
low permeability control (Ranitidine). Of our measured PAB, > 80% had high PAB 
(> 10x10-6 cm/s). Our measured PAB were combined with literature values to 
develop a classification quantitative-structure-property relationship (QSPR) 
model, with a balanced accuracy of 80% for the test set. Measured PAB were also 
used to predict in vivo oral bioavailability (Fbio,h)in human for 
pharmaceuticals, and performed slightly better (R2: -0.03, RMSE: 0.30) than 
assuming a fixed value for PAB. Additionally, measured PAB were used for 
prediction of in vivo oral bioavailability in rat, which resulted in improved 
prediction of maximum concentration (previous R2: 0.32, updated R2: 0.70). 
Finally, measurement uncertainty was accounted for in estimates of 
oral-equivalent dose (OED) from ToxCast in vitro assays for a simulated 
population using a Monte-Carlo method. OED were subsequently compared with 
exposure estimates, and the influence of different extrapolation assumptions 
on the bioactivity-to-exposure ratio (BER) was evaluated. Generally, the large 
measurement uncertainty for low PAB makes the use of Caco-2 data for accurate 
prediction of point values difficult. However, accounting for uncertainty 
enables the upper limits for oral bioavailability to be accurately represented 
in calculation of OED.

## Prepare for session

### Clear memory
```{r setup}
# Delete all objects from memory:
rm(list=ls())
```

### Set the figure size
```{r knitr_setup}
loc.wd <- "C:/Users/jwambaug/git/comptox-caco2/Honda_Caco2"
knitr::opts_chunk$set(echo = TRUE, fig.width=5, fig.height=4)
knitr::opts_knit$set(root.dir = loc.wd)
```

### Load the relevant libraries
```{r r_setup}

packages <- c("ggplot2","hexbin","dplyr","gplots","httk","RColorBrewer",
        "viridis","data.table","magrittr","readxl",
        "stringr","gridExtra","stringi","RMySQL","DBI","grid","xlsx","lattice",
        "gtable","ggpubr","randomForest","caret","recipes","quantregForest",
        "tcpl","scales")
sapply(packages, require,character.only=TRUE) #Note, the "character.only" argument is necessary her
```

### Load custom scripts for analysis
```{r load_useful_scripts}
source(paste0(loc.wd,"/r_scripts/Honda_caco2_utilities.R"))
#source('C:/Users/GHONDA/Documents/HTTKOralRoute/gh_ionization_functions.R')
#source("C:/Users/GHONDA/Documents/R homebrew/chemprop_connect/query_dsstox.measchemprop.R")
#source(paste0(loc.wd,"/r_scripts/rf_train.R"))
#source(paste0(loc.wd,"/r_scripts/Honda_caco2_fullmodel.R"))


```

## ANALYSIS

Configure figure theme
```{r summary}
low_rec_co <- 0.4
high_rec_co <- 2
gtheme <- theme(axis.title = element_text(size=12,color="black",face="bold"),
                axis.text.y = element_text(size=10, color = "black",face="bold"),
                legend.text = element_text(size = 10),
                legend.title = element_text(size = 10),
                legend.key.size = unit(10, "points"),
                panel.background = element_rect(fill="white"),
                axis.line = element_line(color="black"),
                axis.ticks.y = element_line(color="black"),
                legend.position = "top",
                axis.line.x=element_line(color="black"),
                axis.ticks.x=element_line(color="black"),
                axis.text.x = element_text(size = 10,face="bold",color="black"),
                plot.title = element_text(hjust=0,size=12,face="bold"))
```

### Comparison of In Vivo Data with Predictions based on In vitro Caco2 Measurements 

```{r caco2_inivtro_data}
caco2.dt <- httk::honda2023.data
dim(caco2.dt)
colnames(caco2.dt)[colnames(caco2.dt)=="dtxsid"] <- "DTXSID"
# Add column holding the QSPR predictons:
caco2.dt <- merge(caco2.dt,honda2023.qspr,by="DTXSID")
caco2.dt <- caco2.dt[!duplicated(caco2.dt),]
dim(caco2.dt)
caco2.dt$Pab.Pred.Med <- sapply(caco2.dt$Pab.Quant.Pred,function(x) as.numeric(strsplit(x,",")[[1]][1]))
caco2.dt$Pab.Pred.Low <- sapply(caco2.dt$Pab.Quant.Pred,function(x) as.numeric(strsplit(x,",")[[1]][2]))
caco2.dt$Pab.Pred.High <- sapply(caco2.dt$Pab.Quant.Pred,function(x) as.numeric(strsplit(x,",")[[1]][3]))
  save(caco2.dt,
       file=paste0(loc.wd, 
                   "/r_data/processed/caco2dt.RData"))
```

Load all the parameters needed to make calculations:
```{r permeability_params}
# gut.data; compiled data table of absorption and permeability data 
   load(paste0(loc.wd, "/r_data/processed/all_gut_data_25MAR2019.RData")) 
   pharma <- read_excel(paste0(loc.wd, "/r_data/chemical_lists/DSSTox_PHRMPEND_20170531.xlsx"))
   
   invivo.table <- gut.data
   colnames(invivo.table)[colnames(invivo.table)=="dtxsid"] <- "DTXSID"
   invivo.table <- merge(invivo.table,caco2.dt,by="DTXSID")
   invivo.table <- subset(invivo.table,DTXSID%in% chem.physical_and_invitro.data$DTXSID)
# Annotate chemical class:   
   invivo.table$Class <- "Other"
   invivo.table[invivo.table$DTXSID%in%pharma$DSSTox_Substance_Id,"Class"] <-
     "Pharmaceutical"
# Figure out which chemicals we have sufficient HTTK for to make predictions:
   httk.casrn <- get_cheminfo()
   
   invivo.table[,logP:=chem.physical_and_invitro.data[unlist(sapply(invivo.table$DTXSID, function(x) which(x==chem.physical_and_invitro.data$DTXSID))),"logP"]]
   invivo.table[,MW:=chem.physical_and_invitro.data[unlist(sapply(invivo.table$DTXSID, function(x) which(x==chem.physical_and_invitro.data$DTXSID))),"MW"]]
   
      invivo.table[!is.na(fuph) & 
                     !is.na(clinth) & 
                     casrn %in% httk.casrn, 
                   fuph.adj := parameterize_steadystate(
                     chem.cas = casrn, 
                     species = "Human",
                     suppress.messages = TRUE)$Funbound.plasma,
                   .(casrn)]
      invivo.table[!is.na(fupr) & 
                     !is.na(clintr) & 
                     casrn %in% httk.casrn, 
                   fupr.adj := parameterize_steadystate(
                     chem.cas = casrn, 
                     species = "Rat",
                     suppress.messages = TRUE,
                     default.to.human=TRUE)$Funbound.plasma,
                   .(casrn)]
      invivo.table[!is.na(fuph) & 
                     !is.na(clinth) & 
                     !is.na(logP) & 
                     !is.na(MW) & 
                     casrn %in% httk.casrn,cluh_us:=calc_hep_clearance(
                       chem.cas = casrn[1],
                       species = "Human", 
                       hepatic.model = "unscaled",
                       suppress.messages = TRUE),
                   .(casrn)] 
      invivo.table[!is.na(fupr) & 
                     !is.na(clintr) & 
                     !is.na(logP) & 
                     !is.na(MW) & 
                     casrn %in% httk.casrn,
                   clur_us:=calc_hep_clearance(
                     chem.cas = casrn[1],
                     species = "Rat", 
                     hepatic.model = "unscaled",
                     suppress.messages = TRUE,default.to.human=TRUE),
                   .(casrn)] 
      invivo.table[!is.na(fupr) & 
                     !is.na(clintr) & 
                     !is.na(logP) & 
                     !is.na(MW) & 
                     casrn %in% httk.casrn,
                   ffpr_us:=calc_Ffp(
                       species="Rat",
                       chem.cas= casrn,
                       clu=unique(clur_us)),
                   .(casrn)]
      invivo.table[!is.na(fuph) & 
                     !is.na(clinth) & 
                     !is.na(logP) & 
                     !is.na(MW) & 
                     casrn %in% httk.casrn,
                   ffph_us:=calc_Ffp(
                     species="Human",
                     chem.cas= casrn,
                     clu=unique(cluh_us)),
                   .(casrn)]
      invivo.table[!is.na(fuph) & 
                     !is.na(logP) & 
                     !is.na(MW) & 
                     casrn %in% httk.casrn, 
                   rb2ph := available_rblood2plasma(
                     species="Human",
                     chem.cas= casrn,
                     suppress.messages = TRUE),
                   .(casrn)]
      invivo.table[!is.na(fupr) & 
                     !is.na(logP) & 
                     !is.na(MW) & 
                     casrn %in% httk.casrn, 
                   rb2pr := available_rblood2plasma(
                     species="Rat",
                     chem.cas= casrn,
                     suppress.messages = TRUE),
                   .(casrn)]
      
  invivo.table[,cluh_hep:=cluh_us*70] %>% # L/h for 70 kg human
        .[,cluh_gut:=cluh_hep/100] %>% # approximate ratio of cyp abundances
        .[,clur_hep:=clur_us*0.25] %>% # L/h for 0.25 kg rat
        .[,clur_gut:=clur_hep/100] %>% 
        .[,ffph:=ffph_us] %>% 
        .[,ffpr:=ffpr_us]
     save(invivo.table, file=paste0(loc.wd, "/r_data/processed/caco2-invivo-compare1.RData")) 
```   
These calculations should match both the manuscript text and the code in calc_oral_bioavailability.R
```{r Caco_permeability_calcs} 
# Define a rate of intestinal transport to compete with absorption for poorly
# absorbed chemicals:
Qintesttransport <- 1

    load(file=paste0(loc.wd, "/r_data/processed/caco2-invivo-compare1.RData")) 
   invivo.table[,use.pab:=Pab]
   invivo.table[,Pab.Type:="Measured"]
   invivo.table[is.na(use.pab),"Pab.Type"] <- "QSPR"
   invivo.table[is.na(use.pab),use.pab:=Pab.Pred.Med]
   # Yang 2007 for Caco2 pH7.4
   # peff dimensional 10-4 cm/s
   invivo.table[,peffh:=(10^(0.4926*log10(use.pab)-0.1454))] %>% 
   # Fagerholm 1996
        .[,peffr:=peffh/3.6] %>% 
   # m2 area intestine -- Yang et al. (2007)
        .[,Asmallintestineh:=0.66] %>% 
        .[,Asmallintestiner:=71/(100^2)] %>%
   # permeability clearance (CLperm) Yang et al. (2007) equation 8:
   # 10^-4 cm / s * m2 * 1000 L / m^3 / 10^4 * 1 m / 100 cm * 3600 s / h = L / h
        .[,CLpermh:=peffh * Asmallintestineh * 1000/10^4/100*3600] %>%
        .[,CLpermr:=peffr * Asmallintestiner * 1000/10^4/100*3600] %>%
   # Yang et al. (2007) value of 18 L/h blood flow to microvilli of intestinal lumen
        .[,Qvillih:=18] %>% 
        .[,Qvillir:=0.65] %>%
   # Qgut "in terms of fundamental parameters" -- Yang et al. (2007) equation 6:
        .[,Qguth:=Qvillih * CLpermh / (Qvillih + CLpermh)] %>% 
        .[,Qgutr:=Qvillir * CLpermr / (Qvillir + CLpermr)] %>%
   # Qgut Model -- Yang et al. (2007) equation 5:
        .[,fgh_qg:=Qguth/(Qguth+ fuph.adj*cluh_gut/rb2ph*(1 + Qguth/CLpermh))*Qguth/(Qguth+Qintesttransport)] %>% 
        .[,fgr_qg:=Qgutr/(Qgutr + fupr.adj*clur_gut/rb2pr*(1 + Qgutr/CLpermr))*Qguth/(Qguth+Qintesttransport)] %>%
   # Darwich et al. (2010) Equation 3
        .[,fah_darwichh:=1 - (1 + 0.54 * peffh)^-7] %>% 
        .[,fah_darwichr:=1 - (1 + 0.54 * peffr)^-7] %>% 
   # Darwich et al. (2010) Equation 1
        .[,fbioh:=ffph*fgh_qg*fah_darwichh] %>% 
        .[,fbior:=ffpr*fgr_qg*fah_darwichr]
   
   save(invivo.table, file=paste0(loc.wd, "/r_data/processed/caco2-invivo-compare2.RData"))    
```   

# Measured data from Lanevskij and Didziapetris (2019)
```{r make_caco_peff_fig}
load(file=paste0(loc.wd, "/r_data/processed/caco2-invivo-compare2.RData"))    
      FigCacoPredPeff <- ggplot(invivo.table)+
        geom_point(aes(x = mpeff_lit, y = peffh, color=Class, shape=Class), 
                   alpha = 0.75,
                   size=3)+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(y = expression(bold("Pred. ")*bolditalic("P"["eff,h"])~bold('(10'^'-4'~'cm/s)')),
             x = expression(bold("Measured ")*bolditalic("P"["eff,h"])~bold('(10'^'-4'~'cm/s)')))+
    #    lims(x = c(-2,2), y = c(-2,2)) +
        scale_colour_viridis_d()+
          scale_x_log10()+
        scale_y_log10()+
        gtheme +
        theme(axis.title = element_text(size = 8)) 
print(FigCacoPredPeff)
    ggsave(FigCacoPredPeff, file = paste0(loc.wd, "/r_data/results_for_paper/FigCacoPredPeff.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```
# Measured data from Kim et al. (2014)
```{r make_Caco_Fbio_kim_fig}
load(file=paste0(loc.wd, "/r_data/processed/caco2-invivo-compare2.RData"))    
      FigCacoPredFbioKim <- ggplot(invivo.table)+
        geom_point(aes(y = fbioh, x = kim_fbioh, color=Class, shape=Class), 
                   alpha = 0.75,
                   size=3)+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(y = expression(bold("Pred.")~bolditalic("F"["bio,h"])),
             x = expression(bold("Measured")~bolditalic("F"["bio,h"])))+
        lims(x = c(0,1), y = c(0,1))+
        scale_colour_viridis_d()+
        gtheme
print(FigCacoPredFbioKim)
    ggsave(FigCacoPredFbioKim, file = paste0(loc.wd, "/r_data/results_for_paper/FigCacoPredFbioKim.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```
# Measured data collected by Varma et al. (2010)
```{r make_Caco_Fabs_fig}
load(file=paste0(loc.wd, "/r_data/processed/caco2-invivo-compare2.RData"))    
FigCacoPredFabs <- ggplot(invivo.table)+
        geom_point(aes(y = fah_darwichh, x = vo_Fa, color=Class, shape=Class), 
                   alpha = 0.75,
                   size=3)+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(y = expression(bold("Pred.")~bolditalic("F"["abs,h"])),
             x = expression(bold("Measured")~bolditalic("F"["abs,h"])))+
        lims(x = c(0,1), y = c(0,1))+
        scale_colour_viridis_d()+
        gtheme 
print(FigCacoPredFabs)
    ggsave(FigCacoPredFabs, file = paste0(loc.wd, "/r_data/results_for_paper/FigCacoPredFabs.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```
# Measured data collected by Varma et al. (2010)
```{r make_Caco_Fgut_fig}
load(file=paste0(loc.wd, "/r_data/processed/caco2-invivo-compare2.RData"))    
  FigCacoPredFgut <- ggplot(invivo.table)+
        geom_point(aes(y = fgh_qg, x = vo_Fg, color=Class, shape=Class), 
                   alpha = 0.75,
                   size=3)+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(y = expression(bold("Pred.")~bolditalic("F"["gut,h"])),
             x = expression(bold("Measured")~bolditalic("F"["gut,h"])))+
        lims(x = c(0,1), y = c(0,1))+
        scale_colour_viridis_d()+
        gtheme
  print(FigCacoPredFgut)
  ggsave(FigCacoPredFgut, file = paste0(loc.wd, "/r_data/results_for_paper/FigCacoPredFgut.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```
# Measured data collected by Varma et al. (2010) (ffp=fraction first pass)
```{r make_Caco_Fhep_fig}
  load(file=paste0(loc.wd, "/r_data/processed/caco2-invivo-compare2.RData"))    
  
  FigCacoPredFhep <- ggplot(invivo.table) +
  geom_point(aes(y = ffph, x = vo_Fh, color=Class, shape=Class), 
                 alpha = 0.75,
                 size=3) +
  geom_abline(slope = 1, linetype = "dashed") +
  labs(y = expression(bold("Pred.")~bolditalic("F"["hep,h"])),
       x = expression(bold("Measured")~bolditalic("F"["hep,h"]))) +
  lims(x = c(0,1), y = c(0,1)) +
  scale_colour_viridis_d() +
  gtheme
  print(FigCacoPredFhep)
  ggsave(FigCacoPredFhep, file = paste0(loc.wd, "/r_data/results_for_paper/FigCacoPredFhep.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```

# Fbio calculated from measured data collected by Varma et al. (2010)
```{r make_Caco_Fabs_Varma_fig}
  load(file=paste0(loc.wd, "/r_data/processed/caco2-invivo-compare2.RData"))    
  
  FigCacoPredFbioVarma <- ggplot(invivo.table)+
    geom_point(aes(y = fbioh, x = vo_F, color=Class, shape=Class), 
                   alpha = 0.75,
                   size=3)+
    geom_abline(slope = 1, linetype = "dashed")+
    labs(y = expression(bold("Caco2 Predicted")~bolditalic("F"["bio,h"])),
         x = expression(bold("Measured")~bolditalic("F"["bio,h"])))+
    lims(x = c(0,1), y = c(0,1))+
    scale_colour_viridis_d()+
    gtheme
  print(FigCacoPredFbioVarma)
  ggsave(FigCacoPredFbioVarma, file = paste0(loc.wd, "/r_data/results_for_paper/FigCacoPredFbioVarma.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```
# Fbio for rats using Wambaugh et al. (2018) Fbio
```{r make_CacoFabsRat_fig}
  load(file=paste0(loc.wd, "/r_data/processed/caco2-invivo-compare2.RData"))    
  FigCacoPredFbioRat <- ggplot(invivo.table)+
        geom_point(aes(y = fbior, x = pk_fbior, color=Class, shape=Class), 
                   alpha = 0.75,
                   size=3)+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(y = expression(bold("Caco2 Predicted")~bolditalic("F"["bio,r"])),
             x = expression(bold("Measured")~bolditalic("F"["bio,r"])))+
        lims(x = c(0,1), y = c(0,1))+
        scale_colour_viridis_d()+
        gtheme
  print(FigCacoPredFbioRat)
  ggsave(FigCacoPredFbioRat, file = paste0(loc.wd, "/r_data/results_for_paper/FigCacoPredFbioRat.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```
# Fbio using both Kim et al. (2014) and Varma et al. (2010)
```{r make_Caco_Fabs_All_fig}
  load(file=paste0(loc.wd, "/r_data/processed/caco2-invivo-compare2.RData"))

  varma.chems <- subset(invivo.table,!is.na(vo_F))[,
                   c("DTXSID","Class","fbioh","vo_F")]
  kim.chems <- subset(invivo.table,!is.na(kim_fbioh))[,
                 c("DTXSID","Class","fbioh","kim_fbioh")]
  colnames(varma.chems)[4] <- "invivo_fbioh"
  colnames(kim.chems)[4] <- "invivo_fbioh"
  varma.chems$Reference <- "Varma2010"
  kim.chems$Reference <- "Kim2014"
  fbio.table <- rbind(varma.chems,kim.chems)
  invivo.table <- fbio.table
  save(invivo.table,
     file=paste0(loc.wd, 
                 "/r_data/processed/caco2-invivo-compare-fbioall.RData"))

  FigCacoPredFbioAll <- ggplot(fbio.table)+
    geom_point(aes(y = fbioh, x = invivo_fbioh, color=Class, shape=Class), 
                   alpha = 0.75,
                   size=3)+
    geom_abline(slope = 1, linetype = "dashed")+
    labs(y = expression(bold("Caco2 Predicted")~bolditalic("F"["bio,h"])),
         x = expression(bold("Measured")~bolditalic("F"["bio,h"])))+
    lims(x = c(0,1), y = c(0,1))+
    scale_colour_viridis_d()+
    gtheme
  print(FigCacoPredFbioAll)
  ggsave(FigCacoPredFbioAll, 
         file = paste0(loc.wd, 
                       "/r_data/results_for_paper/FigCacoPredFbioAll.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```
# Combine the evalaution figures of the components of Fbio for the paper:
```{r multipanelfigureforpaper}
ggarrange(FigCacoPredPeff, FigCacoPredFabs, FigCacoPredFgut, FigCacoPredFhep, 
          labels = c("A", "B", "C", "D"),
          ncol = 2, nrow = 2,
          common.legend = TRUE, legend = "bottom")
tiff(file = paste0(loc.wd, "/r_data/results_for_paper/FigCacoPredFbioComponents.tiff"),
         height = 3*200, width = 3*200, compression = "lzw")
ggarrange(FigCacoPredPeff, FigCacoPredFabs, FigCacoPredFgut, FigCacoPredFhep, 
          labels = c("A", "B", "C", "D"),
          ncol = 2, nrow = 2,
          common.legend = TRUE, legend = "bottom"+
          theme_gray(base_size = 18))
dev.off()
```
### QSPR Evaluation:

```{r caco2_qspr_pab_eval_fig}
# Annotate chemical class:   
   caco2.dt$Class <- "Other"
   caco2.dt[caco2.dt$DTXSID%in%pharma$DSSTox_Substance_Id,"Class"] <-
     "Pharmaceutical"
   
      FigQSPRPredPab <- ggplot(caco2.dt)+
        geom_point(aes(x = Pab, y = Pab.Pred.Med, color=Class, shape=Class), 
                   alpha = 0.15,
                   position = position_jitter(w = 0.0, h = 0.1),
                   size=3)+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(y = expression(bold("QSPR Predicted log"["10"])*bolditalic("P"["ab"])~bold('(10'^'-6'~'cm/s)')),
             x = expression(bold("Measured log"["10"])*bolditalic("P"["ab"])~bold('(10'^'-6'~'cm/s)')))+
       # lims(x = c(-5,3), y = c(-5,3)) +
        scale_x_log10()+
        scale_y_log10()+
        scale_colour_viridis_d()+
        gtheme
  print(FigQSPRPredPab)
    ggsave(FigQSPRPredPab, file = paste0(loc.wd, 
                                         "/r_data/results_for_paper/FigQSPRPredPab.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```

Repeat all the previous figures, but use the QSPR predictions.

Load all the parameters needed to make calculations:
```{r qspr_permeability_params}
   load_honda2023(overwrite=TRUE)
   invivo.table <- gut.data
   colnames(invivo.table)[colnames(invivo.table)=="dtxsid"] <- "DTXSID"
   invivo.table <- merge(invivo.table,caco2.dt,by="DTXSID")
   invivo.table <- subset(invivo.table,DTXSID%in% chem.physical_and_invitro.data$DTXSID)
   httk.casrn <- get_cheminfo()
   
   invivo.table[,
                logP:=chem.physical_and_invitro.data[unlist(sapply(invivo.table$DTXSID, function(x) which(x==chem.physical_and_invitro.data$DTXSID))),"logP"]]
   invivo.table[,
                MW:=chem.physical_and_invitro.data[unlist(sapply(invivo.table$DTXSID, function(x) which(x==chem.physical_and_invitro.data$DTXSID))),"MW"]]
   
      invivo.table[!is.na(fuph) & 
                     !is.na(clinth) & 
                     casrn %in% httk.casrn, 
                   fuph.adj := parameterize_steadystate(
                     chem.cas = casrn, 
                     species = "Human",
                     suppress.messages = TRUE)$Funbound.plasma,
                   .(casrn)]
      invivo.table[!is.na(fupr) & 
                     !is.na(clintr) & 
                     casrn %in% httk.casrn, 
                   fupr.adj := parameterize_steadystate(
                     chem.cas = casrn, 
                     species = "Rat",
                     suppress.messages = TRUE,
                     default.to.human=TRUE)$Funbound.plasma,
                   .(casrn)]
      invivo.table[!is.na(fuph) & 
                     !is.na(clinth) & 
                     !is.na(logP) & 
                     !is.na(MW) & 
                     casrn %in% httk.casrn,cluh_us:=calc_hep_clearance(
                       chem.cas = casrn[1],
                       species = "Human", 
                       hepatic.model = "unscaled",
                       suppress.messages = TRUE),
                   .(casrn)] 
      invivo.table[!is.na(fupr) & 
                     !is.na(clintr) & 
                     !is.na(logP) & 
                     !is.na(MW) & 
                     casrn %in% httk.casrn,
                   clur_us:=calc_hep_clearance(
                     chem.cas = casrn[1],
                     species = "Rat", 
                     hepatic.model = "unscaled",
                     suppress.messages = TRUE,
                     default.to.human=TRUE),
                   .(casrn)] 
      invivo.table[!is.na(fupr) & 
                     !is.na(clintr) & 
                     !is.na(logP) & 
                     !is.na(MW) & 
                     casrn %in% httk.casrn,
                   ffpr_us:=calc_Ffp(
                     species="Rat",
                     chem.cas= casrn,
                     clu=unique(clur_us)),
                   .(casrn)]
      invivo.table[!is.na(fuph) & 
                     !is.na(clinth) & 
                     !is.na(logP) & 
                     !is.na(MW) & 
                     casrn %in% httk.casrn,
                   ffph_us:=calc_Ffp(
                     species="Human",
                     chem.cas= casrn,
                     clu=unique(cluh_us)),
                   .(casrn)]
      invivo.table[!is.na(fuph) & 
                     !is.na(logP) & 
                     !is.na(MW) & 
                     casrn %in% httk.casrn, 
                   rb2ph := available_rblood2plasma(
                     species="Human",
                     chem.cas= casrn,
                     suppress.messages = TRUE),
                   .(casrn)]
      invivo.table[!is.na(fupr) & 
                     !is.na(logP) & 
                     !is.na(MW) & 
                     casrn %in% httk.casrn, 
                   rb2pr := available_rblood2plasma(
                     species="Rat",
                     chem.cas= casrn,
                     suppress.messages = TRUE),
                   .(casrn)]
      
  invivo.table[,cluh_hep:=cluh_us*70] %>% # L/h for 70 kg human
        .[,cluh_gut:=cluh_hep/100] %>% # approximate ratio of cyp abundances
        .[,clur_hep:=clur_us*0.25] %>% # L/h for 0.25 kg rat
        .[,clur_gut:=clur_hep/100] %>% 
        .[,ffph:=ffph_us] %>% 
        .[,ffpr:=ffpr_us]
```   
These calculations should match both the manuscript text and the code in calc_oral_bioavailability.R
```{r qspr_permeability_calcs}  
   invivo.table[,use.pab:=Pab.Pred.Med]
   invivo.table[,Pab.Type:="QSPR"]
   # peff dimensional 10-4 cm/s
   invivo.table[,peffh:=(10^(0.4926*log10(use.pab)-0.1454))] %>% 
   # Fagerholm 1996
        .[,peffr:=peffh/3.6] %>% 
   # m2 area intestine -- Yang et al. (2007)
        .[,Asmallintestineh:=0.66] %>% 
        .[,Asmallintestiner:=71/(100^2)] %>%
   # permeability clearance (CLperm) Yang et al. (2007) equation 8:
   # 10^-4 cm / s * m2 * 1000 L / m^3 / 10^4 * 1 m / 100 cm * 3600 s / h = L / h
        .[,CLpermh :=peffh * Asmallintestineh * 1000/10^4/100*3600] %>% 
        .[,CLpermr :=peffr * Asmallintestiner * 1000/10^4/100*3600] %>% 
   # Yang et al. (2007) value of 18 L/h blood flow to microvilli of intestinal lumen
        .[,Qvillih:=18] %>% 
        .[,Qvillir:=0.65] %>%
   # Qgut "in terms of fundamental parameters" -- Yang et al. (2007) equation 6:
        .[,Qguth:=Qvillih * CLpermh / (Qvillih + CLpermh)] %>% 
        .[,Qgutr:=Qvillir * CLpermr / (Qvillir + CLpermr)] %>%
   # Qgut Model -- Yang et al. (2007) equation 5:
        .[,fgh_qg:=Qguth/(Qguth+ fuph.adj*cluh_gut/rb2ph*(1 + Qguth/CLpermh))*Qguth/(Qguth+Qintesttransport)] %>% 
        .[,fgr_qg:=Qgutr/(Qgutr + fupr.adj*clur_gut/rb2pr*(1 + Qgutr/CLpermr))*Qguth/(Qguth+Qintesttransport)] %>%
   # Darwich et al. (2010) Equation 3
        .[,fah_darwichh:=1 - (1 + 0.54 * peffh)^-7] %>% 
        .[,fah_darwichr:=1 - (1 + 0.54 * peffr)^-7] %>% 
   # Darwich et al. (2010) Equation 1
        .[,fbioh:=ffph*fgh_qg*fah_darwichh] %>% 
        .[,fbior:=ffpr*fgr_qg*fah_darwichr]
  
  save(invivo.table, file=paste0(loc.wd, 
                                 "/r_data/processed/qspr-invivo-compare2.RData"))    
```   
   
```{r make_qspr_peff_fig}
  load(file=paste0(loc.wd, "/r_data/processed/qspr-invivo-compare2.RData"))

  FigQSPRPredPeff <- ggplot(invivo.table)+
    geom_point(aes(x = mpeff_lit, y = peffh, color=Class, shape=Class), 
                alpha = 0.75,
                size=3)+
    geom_abline(slope = 1, linetype = "dashed")+
    labs(y = expression(bold("Pred. ")*bolditalic("P"["eff,h"])~bold('(10'^'-4'~'cm/s)')),
         x = expression(bold("Measured ")*bolditalic("P"["eff,h"])~bold('(10'^'-4'~'cm/s)')))+
    scale_colour_viridis_d()+
    scale_x_log10()+
    scale_y_log10()+
    gtheme +
    theme(axis.title = element_text(size = 8)) 
  print(FigQSPRPredPeff)
  ggsave(FigQSPRPredPeff, file = 
           paste0(loc.wd, "/r_data/results_for_paper/FigQSPRPredPeff.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```
```{r make_QSPR_Fbio_kim_fig}
  load(file=paste0(loc.wd, "/r_data/processed/qspr-invivo-compare2.RData"))

  FigQSPRPredFbioKim <- ggplot(invivo.table)+
  geom_point(aes(y = fbioh, x = kim_fbioh, color=Class, shape=Class), 
                 alpha = 0.75,
                 size=3) +
  geom_abline(slope = 1, linetype = "dashed") +
  labs(y = expression(bold("Pred.")~bolditalic("F"["bio,h"])),
       x = expression(bold("Measured")~bolditalic("F"["bio,h"])))+
  lims(x = c(0,1), y = c(0,1))+
  scale_colour_viridis_d()+
  gtheme
  print(FigQSPRPredFbioKim)
  ggsave(FigQSPRPredFbioKim, file = 
           paste0(loc.wd, "/r_data/results_for_paper/FigQSPRPredFbioKim.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```

```{r make_QSPR_Fabs_fig}
  load(file=paste0(loc.wd, "/r_data/processed/qspr-invivo-compare2.RData"))

  FigQSPRPredFabs <- ggplot(invivo.table) +
    geom_point(aes(y = fah_darwichh, x = vo_Fa, color=Class, shape=Class), 
                   alpha = 0.75,
                   size=3) +
    geom_abline(slope = 1, linetype = "dashed") +
    labs(y = expression(bold("Pred.")~bolditalic("F"["abs,h"])),
         x = expression(bold("Measured")~bolditalic("F"["abs,h"]))) +
    lims(x = c(0,1), y = c(0,1)) +
    scale_colour_viridis_d() +
    gtheme 

  print(FigQSPRPredFabs)
  ggsave(FigQSPRPredFabs, file = 
           paste0(loc.wd, "/r_data/results_for_paper/FigQSPRPredFabs.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```

```{r make_QSPR_Fgut_fig}
  load(file=paste0(loc.wd, "/r_data/processed/qspr-invivo-compare2.RData"))
  
  FigQSPRPredFgut <- ggplot(invivo.table)+
  geom_point(aes(y = fgh_qg, x = vo_Fg, color=Class, shape=Class), 
                 alpha = 0.75,
                 size=3)+
  geom_abline(slope = 1, linetype = "dashed")+
  labs(y = expression(bold("Pred.")~bolditalic("F"["gut,h"])),
       x = expression(bold("Measured")~bolditalic("F"["gut,h"])))+
  lims(x = c(0,1), y = c(0,1))+
  scale_colour_viridis_d()+
  gtheme
  print(FigQSPRPredFgut)
  
  ggsave(FigQSPRPredFgut, file = 
           paste0(loc.wd, "/r_data/results_for_paper/FigQSPRPredFgut.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```

```{r make_QSPR_Fhep_fig}
  load(file=paste0(loc.wd, "/r_data/processed/qspr-invivo-compare2.RData"))

  FigQSPRPredFhep <- ggplot(invivo.table)+
    geom_point(aes(y = ffph, x = vo_Fh, color=Class, shape=Class), 
                   alpha = 0.75,
                   size=3) +
    geom_abline(slope = 1, linetype = "dashed") +
    labs(y = expression(bold("Pred.")~bolditalic("F"["hep,h"])),
         x = expression(bold("Measured")~bolditalic("F"["hep,h"]))) +
    lims(x = c(0,1), y = c(0,1)) +
    scale_colour_viridis_d() +
    gtheme
  print(FigQSPRPredFhep)
  ggsave(FigQSPRPredFhep, file = 
           paste0(loc.wd, "/r_data/results_for_paper/FigQSPRPredFhep.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```

```{r make_QSPR_Fbio_Varma_fig}
  load(file=paste0(loc.wd, "/r_data/processed/qspr-invivo-compare2.RData"))
  
  FigQSPRPredFbioVarma <- ggplot(invivo.table)+
    geom_point(aes(y = fbioh, x = vo_F, color=Class, shape=Class), 
                   alpha = 0.75,
                   size=3)+
    geom_abline(slope = 1, linetype = "dashed")+
    labs(y = expression(bold("Caco2 Predicted")~bolditalic("F"["bio,h"])),
         x = expression(bold("Measured")~bolditalic("F"["bio,h"])))+
    lims(x = c(0,1), y = c(0,1))+
    scale_colour_viridis_d()+
    gtheme
  print(FigQSPRPredFbioVarma)
  ggsave(FigQSPRPredFbioVarma, 
         file = paste0(loc.wd, 
                       "/r_data/results_for_paper/FigQSPRPredFbioVarma.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```
# Fbio using both Kim et al. (2014) and Varma et al. (2010)
```{r make_QSPR_Fbio_all_fig}
  load(file=paste0(loc.wd, "/r_data/processed/qspr-invivo-compare2.RData"))

  varma.chems <- subset(invivo.table,!is.na(vo_F))[,
                   c("DTXSID","Class","fbioh","vo_F")]
  kim.chems <- subset(invivo.table,!is.na(kim_fbioh))[,
                 c("DTXSID","Class","fbioh","kim_fbioh")]
  colnames(varma.chems)[4] <- "invivo_fbioh"
  colnames(kim.chems)[4] <- "invivo_fbioh"
  varma.chems$Reference <- "Varma2010"
  kim.chems$Reference <- "Kim2014"
  fbio.table <- rbind(varma.chems,kim.chems)
  invivo.table <- fbio.table
  save(invivo.table,
       file=paste0(loc.wd, 
                   "/r_data/processed/qspr-invivo-compare-fbioall.RData"))

  FigQSPRPredFbioAll <- ggplot(fbio.table)+
    geom_point(aes(y = fbioh, x = invivo_fbioh, color=Class, shape=Class), 
                   alpha = 0.75,
                   size=3)+
    geom_abline(slope = 1, linetype = "dashed")+
    labs(y = expression(bold("Caco2 Predicted")~bolditalic("F"["bio,h"])),
         x = expression(bold("Measured")~bolditalic("F"["bio,h"])))+
    lims(x = c(0,1), y = c(0,1))+
    scale_colour_viridis_d()+
    gtheme
  print(FigQSPRPredFbioAll)
  ggsave(FigQSPRPredFbioAll, file = 
         paste0(loc.wd, "/r_data/results_for_paper/FigQSPRPredFbioAll.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```
### Evaluation Statistics
```{r eval_table}
evaluations <- data.frame()
evaluations["Peff",c("In Vivo","Predicted","Reference","Data")] <- 
  c("mpeff_lit","peffh","Lanevskij and Didziapetris (2019)",
    "/r_data/processed/caco2-invivo-compare2.RData")
evaluations["Fabs",c("In Vivo","Predicted","Reference","Data")] <- 
  c("vo_Fa","fah_darwichh","Varma et al. (2010)",
    "/r_data/processed/caco2-invivo-compare2.RData")
evaluations["Fgut",c("In Vivo","Predicted","Reference","Data")] <- 
  c("vo_Fg","fgh_qg","Varma et al. (2010)",
    "/r_data/processed/caco2-invivo-compare2.RData")
evaluations["Fhep",c("In Vivo","Predicted","Reference","Data")] <- 
  c("vo_Fh","ffph","Varma et al. (2010)",
    "/r_data/processed/caco2-invivo-compare2.RData")
evaluations["Fbio",c("In Vivo","Predicted","Reference","Data")] <- 
  c("invivo_fbioh","fbioh","Kim et al. (2014) & Varma et al. (2010)",
    "/r_data/processed/caco2-invivo-compare-fbioall.RData")
evaluations["Fbio-Rat",c("In Vivo","Predicted","Reference","Data")] <- 
  c("pk_fbior","fbior","Wambaugh et al. (2018)",
    "/r_data/processed/caco2-invivo-compare2.RData")
evaluations["Fbio-QSPR",c("In Vivo","Predicted","Reference","Data")] <- 
  c("invivo_fbioh","fbioh","Kim et al. (2014) & Varma et al. (2010)",
    "/r_data/processed/qspr-invivo-compare-fbioall.RData")

eval.table <- data.frame()
for (this.evaluation in row.names(evaluations))
{
# Load the relevant invivo.table RData
  load(file=paste0(loc.wd, evaluations[this.evaluation,"Data"]))
# Restrict to only non-NA values:
  invivo.table <- as.data.frame(invivo.table)
  this.data <- subset(invivo.table,
                      !is.na(invivo.table[, evaluations[this.evaluation,"In Vivo"]]) &
                      !is.na(invivo.table[, evaluations[this.evaluation,"Predicted"]]))
  num.chem <- dim(this.data)[1]
  this.fit <- lm(this.data[, evaluations[this.evaluation,"In Vivo"]] ~
                 this.data[, evaluations[this.evaluation,"Predicted"]])
  R2 <- summary(this.fit)$adj.r.squared
  p.value <- summary(this.fit)$coefficients[2,4]
  RMSE <- sqrt(mean((this.data[, evaluations[this.evaluation,"In Vivo"]]  -
                     this.data[, evaluations[this.evaluation,"Predicted"]])^2))
  eval.table[this.evaluation,c("N.Chem","Reference","R2","p.Value","RMSE")] <- c(
    num.chem,
    evaluations[this.evaluation,"Reference"],
    signif(R2,2),
    signif(p.value,2),
    signif(RMSE,3)
  )
}
knitr::kable(eval.table, 
             caption = "Evaluation of predictions against in vivo data for Fbio and contributing factors.",
             floating.environment="sidewaystable") 
write.csv(eval.table,file=paste0(loc.wd,"/r_data/invivoevaluationsummary.csv"))
```
