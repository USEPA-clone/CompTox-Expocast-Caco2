---
title: "Honda et al. (unsubmitted): Analysis and Figure Generation"
author: "Greg Honda"
date: "August 3, 2020"
output: rmarkdown::html_vignette
vignette: >
 %\VignetteIndexEntry{Honda et al. (unsubmitted): Analysis and Figure Generation}
 %\VignetteEngine{knitr::rmarkdown}
 %\VignetteEncoding{UTF-8}
---
wambaugh.john@epa.gov

## Abstract
Apical-to-basolateral (PAB) and basolateral-to-apical (PBA) measurements were 
made in the Caco-2 assay for 484 environmental and pharmaceutical chemicals. 
After filtering, 310 chemicals had a useable PAB and 396 had a useable PBA. 
Replicates (> 30) were measured for the control chemicals Warfarin, Talinolol, 
and Ranitidine. Measurement uncertainty was high (SD: 0.3 log10 units) for the 
low permeability control (Ranitidine). Of our measured PAB, > 80% had high PAB 
(> 10x10-6 cm/s). Our measured PAB were combined with literature values to 
develop a classification quantitative-structure-property relationship (QSPR) 
model, with a balanced accuracy of 80% for the test set. Measured PAB were also 
used to predict in vivo oral bioavailability (Fbio,h)in human for 
pharmaceuticals, and performed slightly better (R2: -0.03, RMSE: 0.30) than 
assuming a fixed value for PAB. Additionally, measured PAB were used for 
prediction of in vivo oral bioavailability in rat, which resulted in improved 
prediction of maximum concentration (previous R2: 0.32, updated R2: 0.70). 
Finally, measurement uncertainty was accounted for in estimates of 
oral-equivalent dose (OED) from ToxCast in vitro assays for a simulated 
population using a Monte-Carlo method. OED were subsequently compared with 
exposure estimates, and the influence of different extrapolation assumptions 
on the bioactivity-to-exposure ratio (BER) was evaluated. Generally, the large 
measurement uncertainty for low PAB makes the use of Caco-2 data for accurate 
prediction of point values difficult. However, accounting for uncertainty 
enables the upper limits for oral bioavailability to be accurately represented 
in calculation of OED.

## Prepare for session

### Clear memory
```{r setup}
# Delete all objects from memory:
rm(list=ls())
```

### Set the figure size
```{r knitr_setup}
loc.wd <- "C:/Users/jwambaug/OneDrive - Environmental Protection Agency (EPA)/Profile/Documents/Research Projects/Caco2/Honda_Caco2"
knitr::opts_chunk$set(echo = TRUE, fig.width=5, fig.height=4)
knitr::opts_knit$set(root.dir = loc.wd)
```

### Load the relevant libraries
```{r r_setup}

packages <- c("ggplot2","hexbin","dplyr","gplots","httk","RColorBrewer",
        "viridis","data.table","magrittr","readxl",
        "stringr","gridExtra","stringi","RMySQL","DBI","grid","xlsx","lattice",
        "gtable","ggpubr","randomForest","caret","recipes","quantregForest",
        "tcpl")
sapply(packages, require,character.only=TRUE) #Note, the "character.only" argument is necessary her
```

### Load custom scripts for analysis
```{r load_useful_scripts}
source(paste0(loc.wd,"/r_scripts/Honda_caco2_utilities.R"))
#source('C:/Users/GHONDA/Documents/HTTKOralRoute/gh_ionization_functions.R')
#source("C:/Users/GHONDA/Documents/R homebrew/chemprop_connect/query_dsstox.measchemprop.R")
#source(paste0(loc.wd,"/r_scripts/rf_train.R"))
#source(paste0(loc.wd,"/r_scripts/Honda_caco2_fullmodel.R"))


```

## ANALYSIS

Configure figure theme
```{r summary}
low_rec_co <- 0.4
high_rec_co <- 2
gtheme <- theme(axis.title = element_text(size=12,color="black",face="bold"),
                axis.text.y = element_text(size=10, color = "black",face="bold"),
                legend.text = element_text(size = 10),
                legend.title = element_text(size = 10),
                legend.key.size = unit(10, "points"),
                panel.background = element_rect(fill="white"),
                axis.line = element_line(color="black"),
                axis.ticks.y = element_line(color="black"),
                legend.position = "top",
                axis.line.x=element_line(color="black"),
                axis.ticks.x=element_line(color="black"),
                axis.text.x = element_text(size = 10,face="bold",color="black"),
                plot.title = element_text(hjust=0,size=12,face="bold"))
```

### Comparison of Caco2 Predictions with In Vivo Data:

```{r caco2_qspr_eval}
caco2.dt <- httk::honda2023.data
dim(caco2.dt)
colnames(caco2.dt)[colnames(caco2.dt)=="dtxsid"] <- "DTXSID"
caco2.dt <- merge(caco2.dt,honda2023.qspr,by="DTXSID")
caco2.dt <- caco2.dt[!duplicated(caco2.dt),]
dim(caco2.dt)
caco2.dt$Pab.Pred.Med <- sapply(caco2.dt$Pab.Quant.Pred,function(x) as.numeric(strsplit(x,",")[[1]][1]))
caco2.dt$Pab.Pred.Low <- sapply(caco2.dt$Pab.Quant.Pred,function(x) as.numeric(strsplit(x,",")[[1]][2]))
caco2.dt$Pab.Pred.High <- sapply(caco2.dt$Pab.Quant.Pred,function(x) as.numeric(strsplit(x,",")[[1]][3]))
```

Load all the parameters needed to make calculations:
```{r permeability_params}
# gut.data; compiled data table of absorption and permeability data 
   load(paste0(loc.wd, "/r_data/processed/all_gut_data_25MAR2019.RData")) 
   pharma <- read_excel(paste0(loc.wd, "/r_data/chemical_lists/DSSTox_PHRMPEND_20170531.xlsx"))
   
   invivo.table <- gut.data
   colnames(invivo.table)[colnames(invivo.table)=="dtxsid"] <- "DTXSID"
   invivo.table <- merge(invivo.table,caco2.dt,by="DTXSID")
   invivo.table <- subset(invivo.table,DTXSID%in% chem.physical_and_invitro.data$DTXSID)
# Annotate chemical class:   
   invivo.table$Class <- "Other"
   invivo.table[invivo.table$DTXSID%in%pharma$DSSTox_Substance_Id,"Class"] <-
     "Pharmaceutical"
# Figure out which chemicals we have sufficient HTTK for to make predictions:
   httk.casrn <- get_cheminfo()
   
   invivo.table[,logP:=chem.physical_and_invitro.data[unlist(sapply(invivo.table$DTXSID, function(x) which(x==chem.physical_and_invitro.data$DTXSID))),"logP"]]
   invivo.table[,MW:=chem.physical_and_invitro.data[unlist(sapply(invivo.table$DTXSID, function(x) which(x==chem.physical_and_invitro.data$DTXSID))),"MW"]]
   
      invivo.table[!is.na(fuph) & 
                     !is.na(clinth) & 
                     casrn %in% httk.casrn, 
                   fuph.adj := parameterize_steadystate(
                     chem.cas = casrn, 
                     species = "Human",
                     suppress.messages = TRUE)$Funbound.plasma,
                   .(casrn)]
      invivo.table[!is.na(fupr) & 
                     !is.na(clintr) & 
                     casrn %in% httk.casrn, 
                   fupr.adj := parameterize_steadystate(
                     chem.cas = casrn, 
                     species = "Rat",
                     suppress.messages = TRUE,
                     default.to.human=TRUE)$Funbound.plasma,
                   .(casrn)]
      invivo.table[!is.na(fuph) & 
                     !is.na(clinth) & 
                     !is.na(logP) & 
                     !is.na(MW) & 
                     casrn %in% httk.casrn,cluh_us:=calc_hep_clearance(
                       chem.cas = casrn[1],
                       species = "Human", 
                       hepatic.model = "unscaled",
                       suppress.messages = TRUE),
                   .(casrn)] 
      invivo.table[!is.na(fupr) & 
                     !is.na(clintr) & 
                     !is.na(logP) & 
                     !is.na(MW) & 
                     casrn %in% httk.casrn,
                   clur_us:=calc_hep_clearance(
                     chem.cas = casrn[1],
                     species = "Rat", 
                     hepatic.model = "unscaled",
                     suppress.messages = TRUE,default.to.human=TRUE),
                   .(casrn)] 
      invivo.table[!is.na(fupr) & 
                     !is.na(clintr) & 
                     !is.na(logP) & 
                     !is.na(MW) & 
                     casrn %in% httk.casrn,
                   ffpr_us:=calc_Ffp(
                       species="Rat",
                       chem.cas= casrn,
                       clu=unique(clur_us)),
                   .(casrn)]
      invivo.table[!is.na(fuph) & 
                     !is.na(clinth) & 
                     !is.na(logP) & 
                     !is.na(MW) & 
                     casrn %in% httk.casrn,
                   ffph_us:=calc_Ffp(
                     species="Human",
                     chem.cas= casrn,
                     clu=unique(cluh_us)),
                   .(casrn)]
      invivo.table[!is.na(fuph) & 
                     !is.na(logP) & 
                     !is.na(MW) & 
                     casrn %in% httk.casrn, 
                   rb2ph := available_rblood2plasma(
                     species="Human",
                     chem.cas= casrn,
                     suppress.messages = TRUE),
                   .(casrn)]
      invivo.table[!is.na(fupr) & 
                     !is.na(logP) & 
                     !is.na(MW) & 
                     casrn %in% httk.casrn, 
                   rb2pr := available_rblood2plasma(
                     species="Rat",
                     chem.cas= casrn,
                     suppress.messages = TRUE),
                   .(casrn)]
      
  invivo.table[,cluh_hep:=cluh_us*70] %>% # L/h for 70 kg human
        .[,cluh_gut:=cluh_hep/100] %>% # approximate ratio of cyp abundances
        .[,clur_hep:=clur_us*0.25] %>% # L/h for 0.25 kg rat
        .[,clur_gut:=clur_hep/100] %>% 
        .[,ffph:=ffph_us] %>% 
        .[,ffpr:=ffpr_us]
```   
These calculations should match both the manuscript text and the code in calc_oral_bioavailability.R
```{r Caco_permeability_calcs}  
   invivo.table[,use.pab:=Pab]
   invivo.table[,Pab.Type:="Measured"]
   invivo.table[is.na(use.pab),"Pab.Type"] <- "QSPR"
   invivo.table[is.na(use.pab),use.pab:=Pab.Pred.Med]
   # Yang 2007 for Caco2 pH7.4
   # peff dimensional 10-4 cm/s
   invivo.table[,peffh:=(10^(0.4926*log10(use.pab)-0.1454))] %>% 
   # Fagerholm 1996
        .[,peffr:=peffh/3.6] %>% 
   # m2 area intestine -- Yang et al. (2007)
        .[,Asmallintestineh:=0.66] %>% 
        .[,Asmallintestiner:=71/(100^2)] %>%
   # permeability clearance (CLperm) Yang et al. (2007) equation 8:
   # 10^-4 cm / s * m2 * 1000 L / m^3 / 10^4 * 1 m / 100 cm * 3600 s / h = L / h
        .[,CLpermh:=peffh * Asmallintestineh * 1000/10^4/100*3600] %>%
        .[,CLpermr:=peffr * Asmallintestiner * 1000/10^4/100*3600] %>%
   # Yang et al. (2007) value of 18 L/h blood flow to microvilli of intestinal lumen
        .[,Qvillih:=18] %>% 
        .[,Qvillir:=0.65] %>%
   # Qgut "in terms of fundamental parameters" -- Yang et al. (2007) equation 6:
        .[,Qguth:=Qvillih * CLpermh / (Qvillih + CLpermh)] %>% 
        .[,Qgutr:=Qvillir * CLpermr / (Qvillir + CLpermr)] %>%
   # Qgut Model -- Yang et al. (2007) equation 5:
        .[,fgh_qg:=Qguth/(Qguth+ fuph.adj*cluh_gut/rb2ph*(1 + Qguth/CLpermh))] %>% 
        .[,fgr_qg:=Qgutr/(Qgutr + fupr.adj*clur_gut/rb2pr*(1 + Qgutr/CLpermr))] %>%
   # Darwich et al. (2010) Equation 3
        .[,fah_darwichh:=1 - (1 + 0.54 * peffh)^-7] %>% 
        .[,fah_darwichr:=1 - (1 + 0.54 * peffr)^-7] %>% 
   # Darwich et al. (2010) Equation 1
        .[,fbioh:=ffph*fgh_qg*fah_darwichh] %>% 
        .[,fbior:=ffpr*fgr_qg*fah_darwichr]
   
   save(invivo.table, file=paste0(loc.wd, "/r_data/processed/caco2-invivo-compare.RData"))    
```   

# Measured data from Lanevskij and Didziapetris (2019)
```{r make_Cacopeff_fig}
load(file=paste0(loc.wd, "/r_data/processed/caco2-invivo-compare.RData"))    
      FigCacoPredPeff <- ggplot(invivo.table)+
        geom_point(aes(x = mpeff_lit, y = peffh, color=Class, shape=Class), 
                   alpha = 0.75,
                   size=3)+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(y = expression(bold("Pred. ")*bolditalic("P"["eff,h"])~bold('(10'^'-4'~'cm/s)')),
             x = expression(bold("Measured ")*bolditalic("P"["eff,h"])~bold('(10'^'-4'~'cm/s)')))+
    #    lims(x = c(-2,2), y = c(-2,2)) +
        scale_colour_viridis_d()+
          scale_x_log10()+
        scale_y_log10()+
        gtheme +
        theme(axis.title = element_text(size = 8)) 
print(FigCacoPredPeff)
    ggsave(FigCacoPredPeff, file = paste0(loc.wd, "/r_data/results_for_paper/FigCacoPredPeff.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```
# Measured data from Kim et al. (2014)
```{r make_CacoFbiokim_fig}
load(file=paste0(loc.wd, "/r_data/processed/caco2-invivo-compare.RData"))    
      FigCacoPredFbioKim <- ggplot(invivo.table)+
        geom_point(aes(y = fbioh, x = kim_fbioh, color=Class, shape=Class), 
                   alpha = 0.75,
                   size=3)+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(y = expression(bold("Pred.")~bolditalic("F"["bio,h"])),
             x = expression(bold("Measured")~bolditalic("F"["bio,h"])))+
        lims(x = c(0,1), y = c(0,1))+
        scale_colour_viridis_d()+
        gtheme
print(FigCacoPredFbioKim)
    ggsave(FigCacoPredFbioKim, file = paste0(loc.wd, "/r_data/results_for_paper/FigCacoPredFbioKim.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```
# Measured data collected by Varma et al. (2010)
```{r make_CacoFabs_fig}
load(file=paste0(loc.wd, "/r_data/processed/caco2-invivo-compare.RData"))    
FigCacoPredFabs <- ggplot(invivo.table)+
        geom_point(aes(y = fah_darwichh, x = vo_Fa, color=Class, shape=Class), 
                   alpha = 0.75,
                   size=3)+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(y = expression(bold("Pred.")~bolditalic("F"["abs,h"])),
             x = expression(bold("Measured")~bolditalic("F"["abs,h"])))+
        lims(x = c(0,1), y = c(0,1))+
        scale_colour_viridis_d()+
        gtheme 
print(FigCacoPredFabs)
    ggsave(FigCacoPredFabs, file = paste0(loc.wd, "/r_data/results_for_paper/FigCacoPredFabs.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```
# Measured data collected by Varma et al. (2010)
```{r make_CacoFgut_fig}
load(file=paste0(loc.wd, "/r_data/processed/caco2-invivo-compare.RData"))    
  FigCacoPredFgut <- ggplot(invivo.table)+
        geom_point(aes(y = fgh_qg, x = vo_Fg, color=Class, shape=Class), 
                   alpha = 0.75,
                   size=3)+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(y = expression(bold("Pred.")~bolditalic("F"["gut,h"])),
             x = expression(bold("Measured")~bolditalic("F"["gut,h"])))+
        lims(x = c(0,1), y = c(0,1))+
        scale_colour_viridis_d()+
        gtheme
  print(FigCacoPredFgut)
  ggsave(FigCacoPredFgut, file = paste0(loc.wd, "/r_data/results_for_paper/FigCacoPredFgut.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```
# Measured data collected by Varma et al. (2010)
```{r make_CacoFhep_fig}
load(file=paste0(loc.wd, "/r_data/processed/caco2-invivo-compare.RData"))    
  FigPredFhep <- ggplot(invivo.table)+
        geom_point(aes(y = ffph, x = vo_Fh, color=Class, shape=Class), 
                   alpha = 0.75,
                   size=3)+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(y = expression(bold("Pred.")~bolditalic("F"["hep,h"])),
             x = expression(bold("Measured")~bolditalic("F"["hep,h"])))+
        lims(x = c(0,1), y = c(0,1))+
    scale_colour_viridis_d()+
        gtheme
  print(FigPredFhep)
  ggsave(FigPredFhep, file = paste0(loc.wd, "/r_data/results_for_paper/FigPredFhep.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```

# Fbio calculated from measured data collected by Varma et al. (2010)
```{r make_CacoFabsVarma_fig}
load(file=paste0(loc.wd, "/r_data/processed/caco2-invivo-compare.RData"))    
  FigCacoPredFbioVarma <- ggplot(invivo.table)+
        geom_point(aes(y = fbioh, x = vo_F, color=Class, shape=Class), 
                   alpha = 0.75,
                   size=3)+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(y = expression(bold("Caco2 Predicted")~bolditalic("F"["bio,h"])),
             x = expression(bold("Measured")~bolditalic("F"["bio,h"])))+
        lims(x = c(0,1), y = c(0,1))+
        scale_colour_viridis_d()+
        gtheme
  print(FigCacoPredFbioVarma)
  ggsave(FigCacoPredFbioVarma, file = paste0(loc.wd, "/r_data/results_for_paper/FigCacoPredFbioVarma.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```
# Fbio using both Kim et al. (2014) and Varma et al. (2010)
```{r make_CacoFabsAll_fig}
load(file=paste0(loc.wd, "/r_data/processed/caco2-invivo-compare.RData"))

varma.chems <- subset(invivo.table,!is.na(vo_F))[,
                 c("DTXSID","Class","fbioh","vo_F")]
kim.chems <- subset(invivo.table,!is.na(kim_fbioh))[,
                 c("DTXSID","Class","fbioh","kim_fbioh")]
colnames(varma.chems)[4] <- "invivo_fbioh"
colnames(kim.chems)[4] <- "invivo_fbioh"
varma.chems$Reference <- "Varma2010"
kim.chems$Reference <- "Kim2014"
fbio.table <- rbind(varma.chems,kim.chems)

  FigCacoPredFbioAll <- ggplot(fbio.table)+
        geom_point(aes(y = fbioh, x = invivo_fbioh, color=Class, shape=Class), 
                   alpha = 0.75,
                   size=3)+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(y = expression(bold("Caco2 Predicted")~bolditalic("F"["bio,h"])),
             x = expression(bold("Measured")~bolditalic("F"["bio,h"])))+
        lims(x = c(0,1), y = c(0,1))+
        scale_colour_viridis_d()+
        gtheme
  print(FigCacoPredFbioAll)
  ggsave(FigCacoPredFbioAll, file = paste0(loc.wd, "/r_data/results_for_paper/FigCacoPredFbioAll.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```
# Combine the evalaution figures of the components of Fbio for the paper:
```{r multipanelfigureforpaper}
ggarrange(FigCacoPredPeff, FigCacoPredFabs, FigCacoPredFgut, FigPredFhep, 
          labels = c("A", "B", "C", "D"),
          ncol = 2, nrow = 2,
          common.legend = TRUE, legend = "bottom")
tiff(file = paste0(loc.wd, "/r_data/results_for_paper/FigCacoPredFbioComponents.tiff"),
         height = 3*200, width = 3*200, compression = "lzw")
ggarrange(FigCacoPredPeff, FigCacoPredFabs, FigCacoPredFgut, FigPredFhep, 
          labels = c("A", "B", "C", "D"),
          ncol = 2, nrow = 2,
          common.legend = TRUE, legend = "bottom"+
          theme_gray(base_size = 18))
dev.off()
```
### QSPR Evaluation:

```{r caco2_qspr_eval_fig}
# Annotate chemical class:   
   caco2.dt$Class <- "Other"
   caco2.dt[caco2.dt$DTXSID%in%pharma$DSSTox_Substance_Id,"Class"] <-
     "Pharmaceutical"
   
      FigQSPRPredPab <- ggplot(caco2.dt)+
        geom_point(aes(x = Pab, y = Pab.Pred.Med, color=Class, shape=Class), 
                   alpha = 0.15,
                   position = position_jitter(w = 0.0, h = 0.1),
                   size=3)+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(y = expression(bold("QSPR Predicted log"["10"])*bolditalic("P"["ab"])~bold('(10'^'-6'~'cm/s)')),
             x = expression(bold("Measured log"["10"])*bolditalic("P"["ab"])~bold('(10'^'-6'~'cm/s)')))+
       # lims(x = c(-5,3), y = c(-5,3)) +
        scale_x_log10()+
        scale_y_log10()+
        scale_colour_viridis_d()+
        gtheme
  print(FigQSPRPredPab)
    ggsave(FigQSPRPredPab, file = paste0(loc.wd, "/r_data/results_for_paper/FigQSPRPredPab.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```

Repeat all the previous figures, but use the QSPR predictions.

Load all the parameters needed to make calculations:
```{r qspr_permeability_params}
   load_honda2023(overwrite=TRUE)
   invivo.table <- gut.data
   colnames(invivo.table)[colnames(invivo.table)=="dtxsid"] <- "DTXSID"
   invivo.table <- merge(invivo.table,caco2.dt,by="DTXSID")
   invivo.table <- subset(invivo.table,DTXSID%in% chem.physical_and_invitro.data$DTXSID)
   httk.casrn <- get_cheminfo()
   
   invivo.table[,
                logP:=chem.physical_and_invitro.data[unlist(sapply(invivo.table$DTXSID, function(x) which(x==chem.physical_and_invitro.data$DTXSID))),"logP"]]
   invivo.table[,
                MW:=chem.physical_and_invitro.data[unlist(sapply(invivo.table$DTXSID, function(x) which(x==chem.physical_and_invitro.data$DTXSID))),"MW"]]
   
      invivo.table[!is.na(fuph) & 
                     !is.na(clinth) & 
                     casrn %in% httk.casrn, 
                   fuph.adj := parameterize_steadystate(
                     chem.cas = casrn, 
                     species = "Human",
                     suppress.messages = TRUE)$Funbound.plasma,
                   .(casrn)]
      invivo.table[!is.na(fupr) & 
                     !is.na(clintr) & 
                     casrn %in% httk.casrn, 
                   fupr.adj := parameterize_steadystate(
                     chem.cas = casrn, 
                     species = "Rat",
                     suppress.messages = TRUE,
                     default.to.human=TRUE)$Funbound.plasma,
                   .(casrn)]
      invivo.table[!is.na(fuph) & 
                     !is.na(clinth) & 
                     !is.na(logP) & 
                     !is.na(MW) & 
                     casrn %in% httk.casrn,cluh_us:=calc_hep_clearance(
                       chem.cas = casrn[1],
                       species = "Human", 
                       hepatic.model = "unscaled",
                       suppress.messages = TRUE),
                   .(casrn)] 
      invivo.table[!is.na(fupr) & 
                     !is.na(clintr) & 
                     !is.na(logP) & 
                     !is.na(MW) & 
                     casrn %in% httk.casrn,
                   clur_us:=calc_hep_clearance(
                     chem.cas = casrn[1],
                     species = "Rat", 
                     hepatic.model = "unscaled",
                     suppress.messages = TRUE,
                     default.to.human=TRUE),
                   .(casrn)] 
      invivo.table[!is.na(fupr) & 
                     !is.na(clintr) & 
                     !is.na(logP) & 
                     !is.na(MW) & 
                     casrn %in% httk.casrn,
                   ffpr_us:=calc_Ffp(
                     species="Rat",
                     chem.cas= casrn,
                     clu=unique(clur_us)),
                   .(casrn)]
      invivo.table[!is.na(fuph) & 
                     !is.na(clinth) & 
                     !is.na(logP) & 
                     !is.na(MW) & 
                     casrn %in% httk.casrn,
                   ffph_us:=calc_Ffp(
                     species="Human",
                     chem.cas= casrn,
                     clu=unique(cluh_us)),
                   .(casrn)]
      invivo.table[!is.na(fuph) & 
                     !is.na(logP) & 
                     !is.na(MW) & 
                     casrn %in% httk.casrn, 
                   rb2ph := available_rblood2plasma(
                     species="Human",
                     chem.cas= casrn,
                     suppress.messages = TRUE),
                   .(casrn)]
      invivo.table[!is.na(fupr) & 
                     !is.na(logP) & 
                     !is.na(MW) & 
                     casrn %in% httk.casrn, 
                   rb2pr := available_rblood2plasma(
                     species="Rat",
                     chem.cas= casrn,
                     suppress.messages = TRUE),
                   .(casrn)]
      
  invivo.table[,cluh_hep:=cluh_us*70] %>% # L/h for 70 kg human
        .[,cluh_gut:=cluh_hep/100] %>% # approximate ratio of cyp abundances
        .[,clur_hep:=clur_us*0.25] %>% # L/h for 0.25 kg rat
        .[,clur_gut:=clur_hep/100] %>% 
        .[,ffph:=ffph_us] %>% 
        .[,ffpr:=ffpr_us]
```   
These calculations should match both the manuscript text and the code in calc_oral_bioavailability.R
```{r qspr_permeability_calcs}  
   invivo.table[,use.pab:=Pab.Pred.Med]
   invivo.table[,Pab.Type:="QSPR"]
   # peff dimensional 10-4 cm/s
   invivo.table[,peffh:=(10^(0.4926*log10(use.pab)-0.1454))] %>% 
   # Fagerholm 1996
        .[,peffr:=peffh/3.6] %>% 
   # m2 area intestine -- Yang et al. (2007)
        .[,Asmallintestineh:=0.66] %>% 
        .[,Asmallintestiner:=71/(100^2)] %>%
   # permeability clearance (CLperm) Yang et al. (2007) equation 8:
   # 10^-4 cm / s * m2 * 1000 L / m^3 / 10^4 * 1 m / 100 cm * 3600 s / h = L / h
        .[,CLpermh :=peffh * Asmallintestineh * 1000/10^4/100*3600] %>% 
        .[,CLpermr :=peffr * Asmallintestiner * 1000/10^4/100*3600] %>% 
   # Yang et al. (2007) value of 18 L/h blood flow to microvilli of intestinal lumen
        .[,Qvillih:=18] %>% 
        .[,Qvillir:=0.65] %>%
   # Qgut "in terms of fundamental parameters" -- Yang et al. (2007) equation 6:
        .[,Qguth:=Qvillih * CLpermh / (Qvillih + CLpermh)] %>% 
        .[,Qgutr:=Qvillir * CLpermr / (Qvillir + CLpermr)] %>%
   # Qgut Model -- Yang et al. (2007) equation 5:
        .[,fgh_qg:=Qguth/(Qguth+ fuph.adj*cluh_gut/rb2ph*(1 + Qguth/CLpermh))] %>% 
        .[,fgr_qg:=Qgutr/(Qgutr + fupr.adj*clur_gut/rb2pr*(1 + Qgutr/CLpermr))] %>%
   # Darwich et al. (2010) Equation 3
        .[,fah_darwichh:=1 - (1 + 0.54 * peffh)^-7] %>% 
        .[,fah_darwichr:=1 - (1 + 0.54 * peffr)^-7] %>% 
   # Darwich et al. (2010) Equation 1
        .[,fbioh:=ffph*fgh_qg*fah_darwichh] %>% 
        .[,fbior:=ffpr*fgr_qg*fah_darwichr]
  
  save(invivo.table, file=paste0(loc.wd, "/r_data/processed/qspr-invivo-compare.RData"))    
```   
   
```{r make_qsprpeff_fig}
  load(file=paste0(loc.wd, "/r_data/processed/qspr-invivo-compare.RData"))
      FigQSPRPredPeff <- ggplot(invivo.table)+
        geom_point(aes(x = mpeff_lit, y = peffh, color=Class, shape=Class), 
                   alpha = 0.75,
                   size=3)+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(y = expression(bold("Caco2 Predicted log"["10"])*bolditalic("P"["eff,h"])~bold('(10'^'-4'~'cm/s)')),
             x = expression(bold("Measured log"["10"])*bolditalic("P"["eff,h"])~bold('(10'^'-4'~'cm/s)')))+
    #    lims(x = c(-2,2), y = c(-2,2)) +
          scale_x_log10()+
        scale_y_log10()+
        scale_colour_viridis_d()+
        gtheme
print(FigQSPRPredPeff)
    ggsave(FigQSPRPredPeff, file = paste0(loc.wd, "/r_data/results_for_paper/FigQSPRPredPeff.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```
```{r make_QSPRFbio_fig}
      FigQSPRPredFbioKim <- ggplot(invivo.table)+
        geom_point(aes(y = fbioh, x = kim_fbioh, color=Class, shape=Class), 
                   alpha = 0.75,
                   size=3)+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(y = expression(bold("Caco2 Predicted")~bolditalic("F"["bio,h"])),
             x = expression(bold("Measured")~bolditalic("F"["bio,h"])))+
        lims(x = c(0,1), y = c(0,1))+
        scale_colour_viridis_d()+
        gtheme
print(FigQSPRPredFbioKim)
    ggsave(FigQSPRPredFbioKim, file = paste0(loc.wd, "/r_data/results_for_paper/FigQSPRPredFbioKim.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```

```{r make_QSPRFabs_fig}
  load(file=paste0(loc.wd, "/r_data/processed/qspr-invivo-compare.RData"))
FigQSPRPredFabs <- ggplot(invivo.table)+
        geom_point(aes(y = fah_darwichh, x = vo_Fa, color=Class, shape=Class), 
                   alpha = 0.75,
                   size=3)+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(y = expression(bold("Caco2 Darwich Predicted")~bolditalic("F"["abs,h"])),
             x = expression(bold("Measured")~bolditalic("F"["abs,h"])))+
        lims(x = c(0,1), y = c(0,1))+
        scale_colour_viridis_d()+
        gtheme 
print(FigQSPRPredFabs)
    ggsave(FigQSPRPredFabs, file = paste0(loc.wd, "/r_data/results_for_paper/FigQSPRPredFabs.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```

```{r make_QSPRFgut_fig}
  load(file=paste0(loc.wd, "/r_data/processed/qspr-invivo-compare.RData"))
FigQSPRPredFgut <- ggplot(invivo.table)+
        geom_point(aes(y = fgh_qg, x = vo_Fg, color=Class, shape=Class), 
                   alpha = 0.75,
                   size=3)+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(y = expression(bold("Caco2 Predicted")~bolditalic("F"["gut,h"])),
             x = expression(bold("Measured")~bolditalic("F"["gut,h"])))+
        lims(x = c(0,1), y = c(0,1))+
        scale_colour_viridis_d()+
        gtheme
  print(FigQSPRPredFgut)
  ggsave(FigQSPRPredFgut, file = paste0(loc.wd, "/r_data/results_for_paper/FigQSPRPredFgut.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```

```{r make_QSPRFhep_fig}
  load(file=paste0(loc.wd, "/r_data/processed/qspr-invivo-compare.RData"))
FigQSPRPredFhep <- ggplot(invivo.table)+
        geom_point(aes(y = ffph, x = vo_Fh, color=Class, shape=Class), 
                   alpha = 0.75,
                   size=3)+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(y = expression(bold("Caco2 Predicted")~bolditalic("F"["hep,h"])),
             x = expression(bold("Measured")~bolditalic("F"["hep,h"])))+
        lims(x = c(0,1), y = c(0,1))+
        scale_colour_viridis_d()+
        gtheme
  print(FigQSPRPredFhep)
  ggsave(FigQSPRPredFhep, file = paste0(loc.wd, "/r_data/results_for_paper/FigQSPRPredFhep.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```

```{r make_QSPRFabsVarma_fig}
  load(file=paste0(loc.wd, "/r_data/processed/qspr-invivo-compare.RData"))
FigQSPRPredFbioVarma <- ggplot(invivo.table)+
        geom_point(aes(y = fbioh, x = vo_F, color=Class, shape=Class), 
                   alpha = 0.75,
                   size=3)+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(y = expression(bold("Caco2 Predicted")~bolditalic("F"["bio,h"])),
             x = expression(bold("Measured")~bolditalic("F"["bio,h"])))+
        lims(x = c(0,1), y = c(0,1))+
        scale_colour_viridis_d()+
        gtheme
  print(FigQSPRPredFbioVarma)
  ggsave(FigQSPRPredFbioVarma, file = paste0(loc.wd, "/r_data/results_for_paper/FigQSPRPredFbioVarma.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```
# Fbio using both Kim et al. (2014) and Varma et al. (2010)
```{r make_QSPRFabsAll_fig}
load(file=paste0(loc.wd, "/r_data/processed/qspr-invivo-compare.RData"))

varma.chems <- subset(invivo.table,!is.na(vo_F))[,
                 c("DTXSID","Class","fbioh","vo_F")]
kim.chems <- subset(invivo.table,!is.na(kim_fbioh))[,
                 c("DTXSID","Class","fbioh","kim_fbioh")]
colnames(varma.chems)[4] <- "invivo_fbioh"
colnames(kim.chems)[4] <- "invivo_fbioh"
varma.chems$Reference <- "Varma2010"
kim.chems$Reference <- "Kim2014"
fbio.table <- rbind(varma.chems,kim.chems)

  FigQSPRPredFbioAll <- ggplot(fbio.table)+
        geom_point(aes(y = fbioh, x = invivo_fbioh, color=Class, shape=Class), 
                   alpha = 0.75,
                   size=3)+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(y = expression(bold("QSPR Predicted")~bolditalic("F"["bio,h"])),
             x = expression(bold("Measured")~bolditalic("F"["bio,h"])))+
        lims(x = c(0,1), y = c(0,1))+
        scale_colour_viridis_d()+
        gtheme
  print(FigQSPRPredFbioAll)
  ggsave(FigQSPRPredFbioAll, file = paste0(loc.wd, "/r_data/results_for_paper/FigQSPRPredFbioAll.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```

## Comparison with Cvt Data

```{r cvt_compare, eval=FALSE}
    #gcl <- marrangeGrob(grobs=list(gcl1,gcl2,gcl3,gcl4),ncol=2,nrow=2,top=NULL)
    #ggsave(gcl,file=paste0(loc.wd,"/r_data/figures/05FEB2019/ffp.png"),dpi=600,height=9,width=9)
    
    load(paste0(loc.wd,"/r_data/tk_data/PKstats-2018-01-16.RData"))
    pkstats2 <- as.data.table(copy(PKstats)) %>% 
      .[Route == "po", Route := "Oral"] %>% 
      .[Route == "iv", Route := "IV"] %>% 
      .[, Route := factor(Route, levels = c("Oral", "IV"))]
    
    ratpk.dt <- copy(pkstats2)
    
    pred.all <- allgut.casrn2[!is.na(dtxsid)][fbio.calc.dt, on = "dtxsid"]
    
    {
      
      pkcomp.dt <- pred.all[pab.use == "default_1.6",][,.("CAS" = casrn, 
                              "fbior_default" = fbior, 
                              "fabsr_default" = fah_darwich,
                              "fgutr_default" = fgr_qg,
                              "fhepr_default" = ffpr)][ratpk.dt, on= "CAS"] %>% 
        .[, AUC_default := AUC.pred] %>% 
        .[Route == "Oral", AUC_default := AUC.pred*fbior_default] %>% 
        .[, Cmax_default := Cmax.pred] %>% 
        .[Route == "Oral", Cmax_default := Cmax.pred*fbior_default] %>% 
        .[, ]
      
      pkcomp.dt <- pred.all[pab.use == "rf_q50",][,.("CAS" = casrn, 
                                                          "fbior_rfq50" = fbior, 
                                                          "fabsr_rfq50" = fah_darwich,
                                                          "fgutr_rfq50" = fgr_qg,
                                                          "fhepr_rfq50" = ffpr)][pkcomp.dt, on= "CAS"] %>% 
        .[, AUC_rfq50 := AUC.pred] %>% 
        .[Route == "Oral", AUC_rfq50 := AUC.pred*fbior_rfq50] %>% 
        .[, Cmax_rfq50 := Cmax.pred] %>% 
        .[Route == "Oral", Cmax_rfq50 := Cmax.pred*fbior_rfq50] %>% 
        .[, ]
      
      pkcomp.dt <- pred.all[pab.use == "mpab",][,.("CAS" = casrn, 
                                                   "fbior_mpab" = fbior, 
                                                   "fabsr_mpab" = fah_darwich,
                                                   "fgutr_mpab" = fgr_qg,
                                                   "fhepr_mpab" = ffpr)][pkcomp.dt, on= "CAS"] %>% 
        .[, AUC_mpab := AUC.pred] %>% 
        .[Route == "Oral", AUC_mpab := AUC.pred*fbior_mpab] %>% 
        .[, Cmax_mpab := Cmax.pred] %>% 
        .[Route == "Oral", Cmax_mpab := Cmax.pred*fbior_mpab] %>% 
        .[, ]
      
      pkcomp.dt <- pred.all[pab.use == "rf_cat.val",][,.("CAS" = casrn, 
                                                   "fbior_rfcat" = fbior, 
                                                   "fabsr_rfcat" = fah_darwich,
                                                   "fgutr_rfcat" = fgr_qg,
                                                   "fhepr_rfcat" = ffpr)][pkcomp.dt, on= "CAS"] %>% 
        .[, AUC_rfcat := AUC.pred] %>% 
        .[Route == "Oral", AUC_rfcat := AUC.pred*fbior_rfcat] %>% 
        .[, Cmax_rfcat := Cmax.pred] %>% 
        .[Route == "Oral", Cmax_rfcat := Cmax.pred*fbior_rfcat]
      
      pkcomp.dt[, AUC_fhep := AUC.pred] %>% 
        .[Route == "Oral", AUC_fhep := AUC.pred*fhepr_default] %>% 
        .[, Cmax_fhep := Cmax.pred] %>% 
        .[Route == "Oral", Cmax_fhep := Cmax.pred*fhepr_default]
      
      fbiorcomp.dt <- unique(pkcomp.dt[,.(CAS, Fbio, fbior_default, fbior_mpab, fbior_rfcat, fbior_rfq50, fhepr_default)])

      
     
      fbior.res <- rbind(rbind(pkcomp.dt[Route == "Oral", xysummary(ymeas = Fbio, ycalc = fbior_mpab)][,"route" := "Oral"],
                    pkcomp.dt[Route == "IV", xysummary(ymeas = Fbio, ycalc = fbior_mpab)][,"route" := "IV"],
                    pkcomp.dt[, xysummary(ymeas = Fbio, ycalc = fbior_mpab)][,"route" := "All"])[,"method" := "mpab"],
              rbind(pkcomp.dt[Route == "Oral", xysummary(ymeas = Fbio, ycalc = fbior_default)][,"route" := "Oral"],
                    pkcomp.dt[Route == "IV", xysummary(ymeas = Fbio, ycalc = fbior_default)][,"route" := "IV"],
                    pkcomp.dt[, xysummary(ymeas = Fbio, ycalc = fbior_default)][,"route" := "All"])[,"method" := "default"],
              rbind(pkcomp.dt[Route == "Oral", xysummary(ymeas = Fbio, ycalc = fbior_rfcat)][,"route" := "Oral"],
                    pkcomp.dt[Route == "IV", xysummary(ymeas = Fbio, ycalc = fbior_rfcat)][,"route" := "IV"],
                    pkcomp.dt[, xysummary(ymeas = Fbio, ycalc = fbior_rfcat)][,"route" := "All"])[,"method" := "rfcat"],
              rbind(pkcomp.dt[Route == "Oral", xysummary(ymeas = Fbio, ycalc = fbior_rfq50)][,"route" := "Oral"],
                    pkcomp.dt[Route == "IV", xysummary(ymeas = Fbio, ycalc = fbior_rfq50)][,"route" := "IV"],
                    pkcomp.dt[, xysummary(ymeas = Fbio, ycalc = fbior_rfq50)][,"route" := "All"])[,"method" := "rfq50"],
              rbind(pkcomp.dt[Route == "Oral", xysummary(ymeas = Fbio, ycalc = fhepr_default)][,"route" := "Oral"],
                    pkcomp.dt[Route == "IV", xysummary(ymeas = Fbio, ycalc = fhepr_default)][,"route" := "IV"],
                    pkcomp.dt[, xysummary(ymeas = Fbio, ycalc = fhepr_default)][,"route" := "All"])[,"method" := "fhep"])[, "measure" := "Fbior"]
        
      auc.res <- rbind(rbind(pkcomp.dt[Route == "Oral", xysummary(ymeas = log10(AUC), ycalc = log10(AUC.pred))][,"route" := "Oral"],
                  pkcomp.dt[Route == "IV", xysummary(ymeas = log10(AUC), ycalc = log10(AUC.pred))][,"route" := "IV"],
                  pkcomp.dt[, xysummary(ymeas = log10(AUC), ycalc = log10(AUC.pred))][,"route" := "All"])[,"method" := "none"],
                  rbind(pkcomp.dt[Route == "Oral", xysummary(ymeas = log10(AUC), ycalc = log10(AUC.pred.Fbio))][,"route" := "Oral"],
                        pkcomp.dt[Route == "IV", xysummary(ymeas = log10(AUC), ycalc = log10(AUC.pred.Fbio))][,"route" := "IV"],
                        pkcomp.dt[, xysummary(ymeas = log10(AUC), ycalc = log10(AUC.pred.Fbio))][,"route" := "All"])[,"method" := "Fbio_meas"],
            rbind(pkcomp.dt[Route == "Oral", xysummary(ymeas = log10(AUC), ycalc = log10(AUC_mpab))][,"route" := "Oral"],
                  pkcomp.dt[Route == "IV", xysummary(ymeas = log10(AUC), ycalc = log10(AUC_mpab))][,"route" := "IV"],
                  pkcomp.dt[, xysummary(ymeas = log10(AUC), ycalc = log10(AUC_mpab))][,"route" := "All"])[,"method" := "mpab"],
            rbind(pkcomp.dt[Route == "Oral", xysummary(ymeas = log10(AUC), ycalc = log10(AUC_default))][,"route" := "Oral"],
                  pkcomp.dt[Route == "IV", xysummary(ymeas = log10(AUC), ycalc = log10(AUC_default))][,"route" := "IV"],
                  pkcomp.dt[, xysummary(ymeas = log10(AUC), ycalc = log10(AUC_default))][,"route" := "All"])[,"method" := "default"],
            rbind(pkcomp.dt[Route == "Oral", xysummary(ymeas = log10(AUC), ycalc = log10(AUC_rfcat))][,"route" := "Oral"],
                  pkcomp.dt[Route == "IV", xysummary(ymeas = log10(AUC), ycalc = log10(AUC_rfcat))][,"route" := "IV"],
                  pkcomp.dt[, xysummary(ymeas = log10(AUC), ycalc = log10(AUC_rfcat))][,"route" := "All"])[,"method" := "rfcat"],
            rbind(pkcomp.dt[Route == "Oral", xysummary(ymeas = log10(AUC), ycalc = log10(AUC_rfq50))][,"route" := "Oral"],
                  pkcomp.dt[Route == "IV", xysummary(ymeas = log10(AUC), ycalc = log10(AUC_rfq50))][,"route" := "IV"],
                  pkcomp.dt[, xysummary(ymeas = log10(AUC), ycalc = log10(AUC_rfq50))][,"route" := "All"])[,"method" := "rfq50"],
            rbind(pkcomp.dt[Route == "Oral", xysummary(ymeas = log10(AUC), ycalc = log10(AUC_fhep))][,"route" := "Oral"],
                  pkcomp.dt[Route == "IV", xysummary(ymeas = log10(AUC), ycalc = log10(AUC_fhep))][,"route" := "IV"],
                  pkcomp.dt[, xysummary(ymeas = log10(AUC), ycalc = log10(AUC_fhep))][,"route" := "All"])[,"method" := "fhep"])[, "measure" := "log10AUC"]
      
      cmax.res <- rbind(rbind(pkcomp.dt[Route == "Oral", xysummary(ymeas = log10(Cmax), ycalc = log10(Cmax.pred))][,"route" := "Oral"],
                  pkcomp.dt[Route == "IV", xysummary(ymeas = log10(Cmax), ycalc = log10(Cmax.pred))][,"route" := "IV"],
                  pkcomp.dt[, xysummary(ymeas = log10(Cmax), ycalc = log10(Cmax.pred))][,"route" := "All"])[,"method" := "none"],
                  rbind(pkcomp.dt[Route == "Oral", xysummary(ymeas = log10(Cmax), ycalc = log10(Cmax.pred.Fbio))][,"route" := "Oral"],
                        pkcomp.dt[Route == "IV", xysummary(ymeas = log10(Cmax), ycalc = log10(Cmax.pred.Fbio))][,"route" := "IV"],
                        pkcomp.dt[, xysummary(ymeas = log10(Cmax), ycalc = log10(Cmax.pred.Fbio))][,"route" := "All"])[,"method" := "Fbio_meas"],
            rbind(pkcomp.dt[Route == "Oral", xysummary(ymeas = log10(Cmax), ycalc = log10(Cmax_mpab))][,"route" := "Oral"],
                  pkcomp.dt[Route == "IV", xysummary(ymeas = log10(Cmax), ycalc = log10(Cmax_mpab))][,"route" := "IV"],
                  pkcomp.dt[, xysummary(ymeas = log10(Cmax), ycalc = log10(Cmax_mpab))][,"route" := "All"])[,"method" := "mpab"],
            rbind(pkcomp.dt[Route == "Oral", xysummary(ymeas = log10(Cmax), ycalc = log10(Cmax_default))][,"route" := "Oral"],
                  pkcomp.dt[Route == "IV", xysummary(ymeas = log10(Cmax), ycalc = log10(Cmax_default))][,"route" := "IV"],
                  pkcomp.dt[, xysummary(ymeas = log10(Cmax), ycalc = log10(Cmax_default))][,"route" := "All"])[,"method" := "default"],
            rbind(pkcomp.dt[Route == "Oral", xysummary(ymeas = log10(Cmax), ycalc = log10(Cmax_rfcat))][,"route" := "Oral"],
                  pkcomp.dt[Route == "IV", xysummary(ymeas = log10(Cmax), ycalc = log10(Cmax_rfcat))][,"route" := "IV"],
                  pkcomp.dt[, xysummary(ymeas = log10(Cmax), ycalc = log10(Cmax_rfcat))][,"route" := "All"])[,"method" := "rfcat"],
            rbind(pkcomp.dt[Route == "Oral", xysummary(ymeas = log10(Cmax), ycalc = log10(Cmax_rfq50))][,"route" := "Oral"],
                  pkcomp.dt[Route == "IV", xysummary(ymeas = log10(Cmax), ycalc = log10(Cmax_rfq50))][,"route" := "IV"],
                  pkcomp.dt[, xysummary(ymeas = log10(Cmax), ycalc = log10(Cmax_rfq50))][,"route" := "All"])[,"method" := "rfq50"],
            rbind(pkcomp.dt[Route == "Oral", xysummary(ymeas = log10(Cmax), ycalc = log10(Cmax_fhep))][,"route" := "Oral"],
                  pkcomp.dt[Route == "IV", xysummary(ymeas = log10(Cmax), ycalc = log10(Cmax_fhep))][,"route" := "IV"],
                  pkcomp.dt[, xysummary(ymeas = log10(Cmax), ycalc = log10(Cmax_fhep))][,"route" := "All"])[,"method" := "fhep"])[, "measure" := "log10Cmax"]
      
      
      write.xlsx(fbior.res, file = paste0(loc.wd, "/r_data/results_for_paper/rat_tk/rat_tk.xlsx"), append = FALSE, sheetName = "fbior")
      write.xlsx(auc.res, file = paste0(loc.wd, "/r_data/results_for_paper/rat_tk/rat_tk.xlsx"), append = TRUE, sheetName = "AUC")
      write.xlsx(cmax.res, file = paste0(loc.wd, "/r_data/results_for_paper/rat_tk/rat_tk.xlsx"), append = TRUE, sheetName = "Cmax")
      comb.res <- rbind(fbior.res, auc.res, cmax.res)
      write.xlsx(comb.res, file = paste0(loc.wd, "/r_data/results_for_paper/rat_tk/rat_tk.xlsx"), append = TRUE, sheetName = "collected")
      comb.res2 <- melt(comb.res[,.(measure, method, route, xyr2, xyrmse, xycor, xyN = as.numeric(xyN))], measure.vars = c("xyr2", "xyrmse", "xycor", "xyN"), value.name = "val")
      comb.res3 <- dcast(comb.res2, route + measure + variable ~ method, value.var = "val")
      write.xlsx(comb.res3, file = paste0(loc.wd, "/r_data/results_for_paper/rat_tk/rat_tk.xlsx"), append = TRUE, sheetName = "collected_pivot")
      
      
      # rbind(pkcomp.dt[Route == "Oral", xysummary(ymeas = log10(Cmax), ycalc = log10(Cmax.pred))][,"route" := "Oral"],
      #       pkcomp.dt[Route == "IV", xysummary(ymeas = log10(Cmax), ycalc = log10(Cmax.pred))][,"route" := "IV"],
      #       pkcomp.dt[, xysummary(ymeas = log10(Cmax), ycalc = log10(Cmax.pred.new))][,"route" := "All"])[,"measure" := "log10Cmax"]
      # 
      leg.fig <- ggplot(pkcomp.dt)+
        geom_point(aes(x = log10(AUC), y= log10(AUC_mpab), color = Route))+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(title = "",
             x = expression(bold("Measured log"["10"]*"AUC (mg*h/L)")),
             y = expression(bold("Predicted log"["10"]*"AUC (mg*h/L)")))+
        theme_bw()+
        gtheme+
        lims(x = c(-4,4), y = c(-4,4))+
        theme(legend.position = "bottom")+
        annotation_custom(grob = text_grob(label = "c)", face = "bold", hjust = 0), 
                          ymin = 3.5, ymax = 3.5, xmin = -4, xmax = -4)
      gleg <- get_legend(leg.fig)
      select_grobs <- function(lay) {
        id <- unique(c(t(lay))) 
        id[!is.na(id)]
      } 
      hlay1 <- rbind(c(1,2,3),
                     c(1,2,3),
                     c(1,2,3),
                     c(1,2,3),
                     c(1,2,3),
                     c(4,4,4))
      hlay2 <- rbind(c(1,2,3,4),
                     c(1,2,3,4),
                     c(1,2,3,4),
                     c(1,2,3,4),
                     c(1,2,3,4),
                     c(5,5,5,5))
      
      
      {
      g2a <- ggplot(pkcomp.dt)+
        geom_point(aes(x = log10(AUC), y= log10(AUC.pred), color = Route))+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(title = "",
             x = expression(bold("Measured log"["10"]*"AUC (mg*h/L)")),
             y = expression(bold("Predicted log"["10"]*"AUC (mg*h/L)")))+
        theme_bw()+
        gtheme+
          theme(legend.position = "none")+
        lims(x = c(-4,4), y = c(-4,4))+
        annotation_custom(grob = text_grob(label = "a)", face = "bold", hjust = 0), 
                          ymin = 3.5, ymax = 3.5, xmin = -4, xmax = -4)
      g2b <- ggplot(pkcomp.dt)+
        geom_point(aes(x = log10(AUC), y= log10(AUC.pred.Fbio), color = Route))+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(title = "",
             x = expression(bold("Measured log"["10"]*"AUC (mg*h/L)")),
             y = expression(bold("Predicted log"["10"]*"AUC (mg*h/L)")))+
        theme_bw()+
        gtheme+
        theme(legend.position = "none")+
        lims(x = c(-4,4), y = c(-4,4))+
        annotation_custom(grob = text_grob(label = "b)", face = "bold", hjust = 0), 
                          ymin = 3.5, ymax = 3.5, xmin = -4, xmax = -4)
      g2c <- ggplot(pkcomp.dt)+
        geom_point(aes(x = log10(AUC), y= log10(AUC_mpab), color = Route))+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(title = "",
             x = expression(bold("Measured log"["10"]*"AUC (mg*h/L)")),
             y = expression(bold("Predicted log"["10"]*"AUC (mg*h/L)")))+
        theme_bw()+
        gtheme+
        theme(legend.position = "none")+
        lims(x = c(-4,4), y = c(-4,4))+
        annotation_custom(grob = text_grob(label = "c)", face = "bold", hjust = 0), 
                          ymin = 3.5, ymax = 3.5, xmin = -4, xmax = -4)
      gs2a <- ggplot(pkcomp.dt)+
        geom_point(aes(x = log10(AUC), y= log10(AUC_fhep), color = Route))+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(title = "",
             x = expression(bold("Measured log"["10"]*"AUC (mg*h/L)")),
             y = expression(bold("Predicted log"["10"]*"AUC (mg*h/L)")))+
        theme_bw()+
        gtheme+
        theme(legend.position = "none")+
        lims(x = c(-4,4), y = c(-4,4))+
        annotation_custom(grob = text_grob(label = "a)", face = "bold", hjust = 0), 
                          ymin = 3.5, ymax = 3.5, xmin = -4, xmax = -4)
      gs2b <- ggplot(pkcomp.dt)+
        geom_point(aes(x = log10(AUC), y= log10(AUC_default), color = Route))+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(title = "",
             x = expression(bold("Measured log"["10"]*"AUC (mg*h/L)")),
             y = expression(bold("Predicted log"["10"]*"AUC (mg*h/L)")))+
        theme_bw()+
        gtheme+
        theme(legend.position = "none")+
        lims(x = c(-4,4), y = c(-4,4))+
        annotation_custom(grob = text_grob(label = "b)", face = "bold", hjust = 0), 
                          ymin = 3.5, ymax = 3.5, xmin = -4, xmax = -4)
      gs2c <- ggplot(pkcomp.dt)+
        geom_point(aes(x = log10(AUC), y= log10(AUC_rfcat), color = Route))+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(title = "",
             x = expression(bold("Measured log"["10"]*"AUC (mg*h/L)")),
             y = expression(bold("Predicted log"["10"]*"AUC (mg*h/L)")))+
        theme_bw()+
        gtheme+
        theme(legend.position = "none")+
        lims(x = c(-4,4), y = c(-4,4))+
        annotation_custom(grob = text_grob(label = "d)", face = "bold", hjust = 0), 
                          ymin = 3.5, ymax = 3.5, xmin = -4, xmax = -4)
      gs2d <- ggplot(pkcomp.dt)+
        geom_point(aes(x = log10(AUC), y= log10(AUC_rfq50), color = Route))+
        geom_abline(slope = 1, linetype = "dashed")+
        labs(title = "",
             x = expression(bold("Measured log"["10"]*"AUC (mg*h/L)")),
             y = expression(bold("Predicted log"["10"]*"AUC (mg*h/L)")))+
        theme_bw()+
        gtheme+
        theme(legend.position = "none")+
        lims(x = c(-4,4), y = c(-4,4))+
        annotation_custom(grob = text_grob(label = "c)", face = "bold", hjust = 0), 
                          ymin = 3.5, ymax = 3.5, xmin = -4, xmax = -4)
      
      
      g2 <- marrangeGrob(grobs = list(g2a, g2b, g2c, gs2c, gleg), nrow = 2, ncol = 3, layout_matrix = hlay2, top = NULL)
      ggsave(g2, file = paste0(loc.wd, "/r_data/results_for_paper/rat_tk/AUC_3x.tiff"), 
             dpi = 600, width = 9, height = 4, compression = "lzw")
      gs2 <- marrangeGrob(grobs = list(gs2a, gs2b, gs2d,gleg), nrow = 2, ncol = 3, layout_matrix = hlay1, top = NULL)
      ggsave(gs2, file = paste0(loc.wd, "/r_data/results_for_paper/rat_tk/sAUC_4x.tiff"), 
             dpi = 600, width = 12, height = 4, compression = "lzw")
      
      }
      
      {
        auc.dt <- rbind(pkcomp.dt[,.(x = AUC, y = AUC.pred, Route)][,"col.nm" := 1],
                        pkcomp.dt[,.(x = AUC, y = AUC.pred.Fbio, Route)][,"col.nm" := 2],
                        pkcomp.dt[,.(x = AUC, y = AUC_mpab, Route)][,"col.nm" := 3],
                        pkcomp.dt[,.(x = AUC, y = AUC_rfcat, Route)][,"col.nm" := 4]
        )
        txt.dt <- data.table(col.nm = 1:4, y = 3.5, x = -3.5, labl = paste0("bold('",c("a","b","c","d"),")')"))
        
        g2 <- ggplot(auc.dt)+
          facet_grid(~col.nm)+
          geom_point(aes(x = log10(x), y = log10(y), color = Route))+
          geom_text(data = txt.dt, aes(x = x, y = y, label = labl), hjust = 0, parse = T)+
          geom_abline(slope = 1, linetype = "dashed")+
          lims(x = c(-4,4), y = c(-4,4))+
          labs(title = "",
               x = expression(bold("Measured log"["10"]*"AUC (mg*h/L)")),
               y = expression(bold("Predicted log"["10"]*"AUC (mg*h/L)")))+
          coord_equal()+
          theme_bw()+
          gtheme+
          theme(strip.background = element_rect(fill = NA, color = NA),
                strip.text = element_blank(),
                legend.position = "bottom")
        
        auc.dt <- rbind(pkcomp.dt[,.(x = AUC, y = AUC_fhep, Route)][,"col.nm" := 1],
                        pkcomp.dt[,.(x = AUC, y = AUC_default, Route)][,"col.nm" := 2],
                        pkcomp.dt[,.(x = AUC, y = AUC_rfq50, Route)][,"col.nm" := 3]
        )
        txt.dt <- data.table(col.nm = 1:3, y = 3.5, x = -3.5, labl = paste0("bold('",c("a","b","c"),")')"))
        
        gs2 <- ggplot(auc.dt)+
          facet_grid(~col.nm)+
          geom_point(aes(x = log10(x), y = log10(y), color = Route))+
          geom_text(data = txt.dt, aes(x = x, y = y, label = labl), hjust = 0, parse = T)+
          geom_abline(slope = 1, linetype = "dashed")+
          lims(x = c(-4,4), y = c(-4,4))+
          labs(title = "",
               x = expression(bold("Measured log"["10"]*"AUC (mg*h/L)")),
               y = expression(bold("Predicted log"["10"]*"AUC (mg*h/L)")))+
          coord_equal()+
          theme_bw()+
          gtheme+
          theme(strip.background = element_rect(fill = NA, color = NA),
                strip.text = element_blank(),
                legend.position = "bottom")
        
        ggsave(g2, file = paste0(loc.wd, "/r_data/results_for_paper/rat_tk/AUC_4x.tiff"), 
               dpi = 600, width = 9, height = 4, compression = "lzw")
        ggsave(gs2, file = paste0(loc.wd, "/r_data/results_for_paper/rat_tk/sAUC_3x.tiff"), 
               dpi = 600, width = 9, height = 4, compression = "lzw")
        
        cmax.dt <- rbind(pkcomp.dt[,.(x = Cmax, y = Cmax.pred, Route)][,"col.nm" := 1],
                        pkcomp.dt[,.(x = Cmax, y = Cmax.pred.Fbio, Route)][,"col.nm" := 2],
                        pkcomp.dt[,.(x = Cmax, y = Cmax_mpab, Route)][,"col.nm" := 3],
                        pkcomp.dt[,.(x = Cmax, y = Cmax_rfcat, Route)][,"col.nm" := 4]
        )
        txt.dt <- data.table(col.nm = 1:4, y = 2, x = -3.5, labl = paste0("bold('",c("a","b","c","d"),")')"))
        
        g3 <- ggplot(cmax.dt)+
          facet_grid(~col.nm)+
          geom_point(aes(x = log10(x), y = log10(y), color = Route))+
          geom_text(data = txt.dt, aes(x = x, y = y, label = labl), hjust = 0, parse = T)+
          geom_abline(slope = 1, linetype = "dashed")+
          lims(x = c(-4,3), y = c(-4,3))+
          labs(title = "",
               x = expression(bold("Measured log"["10"]*bolditalic("C"["max"])~"(mg*h/L)")),
               y = expression(bold("Predicted log"["10"]*bolditalic("C"["max"])~"(mg*h/L)")))+
          coord_equal()+
          theme_bw()+
          gtheme+
          theme(strip.background = element_rect(fill = NA, color = NA),
                strip.text = element_blank(),
                legend.position = "bottom")
        
        cmax.dt <- rbind(pkcomp.dt[,.(x = Cmax, y = Cmax_fhep, Route)][,"col.nm" := 1],
                        pkcomp.dt[,.(x = Cmax, y = Cmax_default, Route)][,"col.nm" := 2],
                        pkcomp.dt[,.(x = Cmax, y = Cmax_rfq50, Route)][,"col.nm" := 3]
        )
        txt.dt <- data.table(col.nm = 1:3, y = 2, x = -3.5, labl = paste0("bold('",c("a","b","c"),")')"))
        
        gs3 <- ggplot(cmax.dt)+
          facet_grid(~col.nm)+
          geom_point(aes(x = log10(x), y = log10(y), color = Route))+
          geom_text(data = txt.dt, aes(x = x, y = y, label = labl), hjust = 0, parse = T)+
          geom_abline(slope = 1, linetype = "dashed")+
          lims(x = c(-4,3), y = c(-4,3))+
          labs(title = "",
               x = expression(bold("Measured log"["10"]*bolditalic("C"["max"])~"(mg*h/L)")),
               y = expression(bold("Predicted log"["10"]*bolditalic("C"["max"])~"(mg*h/L)")))+
          coord_equal()+
          theme_bw()+
          gtheme+
          theme(strip.background = element_rect(fill = NA, color = NA),
                strip.text = element_blank(),
                legend.position = "bottom")
        
        ggsave(g3, file = paste0(loc.wd, "/r_data/results_for_paper/rat_tk/Cmax_4x.tiff"), 
               dpi = 600, width = 9, height = 4, compression = "lzw")
        ggsave(gs3, file = paste0(loc.wd, "/r_data/results_for_paper/rat_tk/sCmax_3x.tiff"), 
               dpi = 600, width = 9, height = 4, compression = "lzw")
      
      
      }
        
        
      {
        g2a <- ggplot(pkcomp.dt)+
          geom_point(aes(x = log10(Cmax), y= log10(Cmax.pred), color = Route))+
          geom_abline(slope = 1, linetype = "dashed")+
          labs(title = "",
               x = expression(bold("Measured log"["10"]*"C"["max"]~"(mg*h/L)")),
               y = expression(bold("Predicted log"["10"]*"C"["max"]~"(mg*h/L)")))+
          theme_bw()+
          gtheme+
          theme(legend.position = "none")+
          lims(x = c(-4,3), y = c(-4,3))+
          annotation_custom(grob = text_grob(label = "a)", face = "bold", hjust = 0), 
                            ymin = 2.5, ymax = 2.5, xmin = -4, xmax = -4)
        g2b <- ggplot(pkcomp.dt)+
          geom_point(aes(x = log10(Cmax), y= log10(Cmax.pred.Fbio), color = Route))+
          geom_abline(slope = 1, linetype = "dashed")+
          labs(title = "",
               x = expression(bold("Measured log"["10"]*"C"["max"]~"(mg*h/L)")),
               y = expression(bold("Predicted log"["10"]*"C"["max"]~"(mg*h/L)")))+
          theme_bw()+
          gtheme+
          theme(legend.position = "none")+
          lims(x = c(-4,3), y = c(-4,3))+
          annotation_custom(grob = text_grob(label = "b)", face = "bold", hjust = 0), 
                            ymin = 2.5, ymax = 2.5, xmin = -4, xmax = -4)
        g2c <- ggplot(pkcomp.dt)+
          geom_point(aes(x = log10(Cmax), y= log10(Cmax_mpab), color = Route))+
          geom_abline(slope = 1, linetype = "dashed")+
          labs(title = "",
               x = expression(bold("Measured log"["10"]*"C"["max"]~"(mg*h/L)")),
               y = expression(bold("Predicted log"["10"]*"C"["max"]~"(mg*h/L)")))+
          theme_bw()+
          gtheme+
          theme(legend.position = "none")+
          lims(x = c(-4,3), y = c(-4,3))+
          annotation_custom(grob = text_grob(label = "c)", face = "bold", hjust = 0), 
                            ymin = 2.5, ymax = 2.5, xmin = -4, xmax = -4)
        gs2a <- ggplot(pkcomp.dt)+
          geom_point(aes(x = log10(Cmax), y= log10(Cmax_fhep), color = Route))+
          geom_abline(slope = 1, linetype = "dashed")+
          labs(title = "",
               x = expression(bold("Measured log"["10"]*"C"["max"]~"(mg*h/L)")),
               y = expression(bold("Predicted log"["10"]*"C"["max"]~"(mg*h/L)")))+
          theme_bw()+
          gtheme+
          theme(legend.position = "none")+
          lims(x = c(-4,3), y = c(-4,3))+
          annotation_custom(grob = text_grob(label = "a)", face = "bold", hjust = 0), 
                            ymin = 2.5, ymax = 2.5, xmin = -4, xmax = -4)
        gs2b <- ggplot(pkcomp.dt)+
          geom_point(aes(x = log10(Cmax), y= log10(Cmax_default), color = Route))+
          geom_abline(slope = 1, linetype = "dashed")+
          labs(title = "",
               x = expression(bold("Measured log"["10"]*"C"["max"]~"(mg*h/L)")),
               y = expression(bold("Predicted log"["10"]*"C"["max"]~"(mg*h/L)")))+
          theme_bw()+
          gtheme+
          theme(legend.position = "none")+
          lims(x = c(-4,3), y = c(-4,3))+
          annotation_custom(grob = text_grob(label = "b)", face = "bold", hjust = 0), 
                            ymin = 2.5, ymax = 2.5, xmin = -4, xmax = -4)
        gs2c <- ggplot(pkcomp.dt)+
          geom_point(aes(x = log10(Cmax), y= log10(Cmax_rfcat), color = Route))+
          geom_abline(slope = 1, linetype = "dashed")+
          labs(title = "",
               x = expression(bold("Measured log"["10"]*"C"["max"]~"(mg*h/L)")),
               y = expression(bold("Predicted log"["10"]*"C"["max"]~"(mg*h/L)")))+
          theme_bw()+
          gtheme+
          theme(legend.position = "none")+
          lims(x = c(-4,3), y = c(-4,3))+
          annotation_custom(grob = text_grob(label = "c)", face = "bold", hjust = 0), 
                            ymin = 2.5, ymax = 2.5, xmin = -4, xmax = -4)
        gs2d <- ggplot(pkcomp.dt)+
          geom_point(aes(x = log10(Cmax), y= log10(Cmax_rfq50), color = Route))+
          geom_abline(slope = 1, linetype = "dashed")+
          labs(title = "",
               x = expression(bold("Measured log"["10"]*"C"["max"]~"(mg*h/L)")),
               y = expression(bold("Predicted log"["10"]*"C"["max"]~"(mg*h/L)")))+
          theme_bw()+
          gtheme+
          theme(legend.position = "none")+
          lims(x = c(-4,3), y = c(-4,3))+
          annotation_custom(grob = text_grob(label = "d)", face = "bold", hjust = 0), 
                            ymin = 2.5, ymax = 2.5, xmin = -4, xmax = -4)
        
        g2 <- marrangeGrob(grobs = list(g2a, g2b, g2c, gleg), nrow = 2, ncol = 3, layout_matrix = hlay1, top = NULL)
        ggsave(g2, file = paste0(loc.wd, "/r_data/results_for_paper/rat_tk/Cmax_3x.tiff"), 
               dpi = 600, width = 9, height = 4, compression = "lzw")
        gs2 <- marrangeGrob(grobs = list(gs2a, gs2b, gs2c,gs2d,gleg), nrow = 2, ncol = 3, layout_matrix = hlay2, top = NULL)
        ggsave(gs2, file = paste0(loc.wd, "/r_data/results_for_paper/rat_tk/sCmax_4x.tiff"), 
               dpi = 600, width = 12, height = 4, compression = "lzw")
      }
      
      {
        
        g2 <- ggplot(pkcomp.dt)+
          geom_point(aes(x = Fbio, y= (fbior_mpab)))+
          geom_abline(slope = 1, linetype = "dashed")+
          labs(title = "",
               x = expression(bold("Measured ")*bolditalic("F"["bio,r"])),
               y = expression(bold("Predicted ")*bolditalic("F"["bio,r"])))+
          theme_bw()+
          gtheme+
          lims(x = c(0,1), y = c(0,1))
        
        gs2a <- ggplot(pkcomp.dt)+
          geom_point(aes(x = Fbio, y= (fhepr_default)))+
          geom_abline(slope = 1, linetype = "dashed")+
          labs(title = "",
               x = expression(bold("Measured ")*bolditalic("F"["bio,r"])),
               y = expression(bold("Predicted ")*bolditalic("F"["hep,r"])))+
          theme_bw()+
          gtheme+
          lims(x = c(0,1), y = c(0,1))+
          annotation_custom(grob = text_grob(label = "a)", face = "bold", hjust = 0), 
                            ymin = 2.5, ymax = 2.5, xmin = -4, xmax = -4)
        gs2b <- ggplot(pkcomp.dt)+
          geom_point(aes(x = Fbio, y= (fbior_default)))+
          geom_abline(slope = 1, linetype = "dashed")+
          labs(title = "",
               x = expression(bold("Measured ")*bolditalic("F"["bio,r"])),
               y = expression(bold("Predicted ")*bolditalic("F"["bio,r"])))+
          theme_bw()+
          gtheme+
          lims(x = c(0,1), y = c(0,1))+
          annotation_custom(grob = text_grob(label = "b)", face = "bold", hjust = 0), 
                            ymin = 2.5, ymax = 2.5, xmin = -4, xmax = -4)
        gs2c <- ggplot(pkcomp.dt)+
          geom_point(aes(x = Fbio, y= (fbior_rfcat)))+
          geom_abline(slope = 1, linetype = "dashed")+
          labs(title = "",
               x = expression(bold("Measured ")*bolditalic("F"["bio,r"])),
               y = expression(bold("Predicted ")*bolditalic("F"["bio,r"])))+
          theme_bw()+
          gtheme+
          lims(x = c(0,1), y = c(0,1))+
          annotation_custom(grob = text_grob(label = "c)", face = "bold", hjust = 0), 
                            ymin = 2.5, ymax = 2.5, xmin = -4, xmax = -4)
        gs2d <- ggplot(pkcomp.dt)+
          geom_point(aes(x = Fbio, y= (fbior_rfq50)))+
          geom_abline(slope = 1, linetype = "dashed")+
          labs(title = "",
               x = expression(bold("Measured ")*bolditalic("F"["bio,r"])),
               y = expression(bold("Predicted ")*bolditalic("F"["bio,r"])))+
          theme_bw()+
          gtheme+
          lims(x = c(0,1), y = c(0,1))+
          annotation_custom(grob = text_grob(label = "d)", face = "bold", hjust = 0), 
                            ymin = 2.5, ymax = 2.5, xmin = -4, xmax = -4)
        
        ggsave(g2, file = paste0(loc.wd, "/r_data/results_for_paper/rat_tk/Fbior_1x.tiff"), 
               dpi = 600, width = 4, height = 4, compression = "lzw")
        gs2 <- marrangeGrob(grobs = list(gs2a, gs2b, gs2c,gs2d), nrow = 1, ncol = 4, top = NULL)
        ggsave(gs2, file = paste0(loc.wd, "/r_data/results_for_paper/rat_tk/Fbior_4x.tiff"), 
               dpi = 600, width = 12, height = 3, compression = "lzw")
      }
      
    }
  
```


#### BER plots ####
```{r BER1}
# collect httk chems for IVIVE
chem.dt <- as.data.table(chem.physical_and_invitro.data)
temp <- chem.dt[!is.na(DTXSID) &
                  !is.na(logP) &
                  !is.na(MP) &
                  !is.na(Human.Funbound.plasma) &
                  !is.na(Human.Clint),
                .(DTXSID, CAS, Compound, logP, Human.Funbound.plasma, Human.Clint, Human.Caco2.Pab)
                ]
for(this.cas in temp[regexpr("<",Human.Clint) == -1 &
                     Human.Clint != "ND" &
                     Human.Funbound.plasma != "NF",CAS]){
  parameters <- parameterize_steadystate(chem.cas = this.cas,
                                         suppress.messages=TRUE)
  temp[CAS == this.cas, adj.fuph := parameters$Funbound.plasma] %>% 
    .[CAS == this.cas, clinth := parameters$Clint]
  
}
use.dt <- temp[!is.na(adj.fuph) & !is.na(clinth), ]

# Calculate css for different IVIVE assumptions
set.seed(6252019)
use.dt[, r1_mcaco2 := .(list(suppressWarnings(calc_mc_css(chem.cas = CAS,
                                         which.quantile = c(0.025,0.05,0.25,0.5,
                                                            0.75,0.95,0.975),
                                         Caco2.options = list(Caco2.Pab.default = "1.6",
                                                              Caco2.Fabs = TRUE,
                                                              Caco2.Fgut = TRUE,
                                                              overwrite.invivo = TRUE,
                                                              keepit100 = FALSE),
                                         output.units = "uM",
                                         suppress.messages=TRUE)))),.(CAS)] %>% 
  .[, r2_mfabs := .(list(suppressWarnings(calc_mc_css(chem.cas = CAS,
                                     which.quantile = c(0.025,0.05,0.25,0.5,
                                                        0.75,0.95,0.975),
                                     Caco2.options = list(Caco2.Pab.default = "1.6",
                                                          Caco2.Fabs = FALSE,
                                                          Caco2.Fgut = FALSE,
                                                          overwrite.invivo = FALSE,
                                                          keepit100 = FALSE),
                                     output.units = "uM",
                                         suppress.messages=TRUE)))),.(CAS)] %>% 
  .[, r3_mcaco2_honda1 := .(list(suppressWarnings(calc_mc_css(chem.cas = CAS,
                                             which.quantile = c(0.025,0.05,0.25,0.5,
                                                                0.75,0.95,0.975),
                                             Caco2.options = list(Caco2.Pab.default = "1.6",
                                                                  Caco2.Fabs = TRUE,
                                                                  Caco2.Fgut = TRUE,
                                                                  overwrite.invivo = TRUE,
                                                                  keepit100 = FALSE),
                                             output.units = "uM",
                                             calc.analytic.css.arg.list = list(
                                               IVIVE = "Honda1"),
                                         suppress.messages=TRUE)))),.(CAS)] %>% 
  .[, r4_mfabs_honda1 := .(list(suppressWarnings(calc_mc_css(chem.cas = CAS,
                                            which.quantile = c(0.025,0.05,0.25,0.5,
                                                               0.75,0.95,0.975),
                                            Caco2.options = list(Caco2.Pab.default = "1.6",
                                                                 Caco2.Fabs = FALSE,
                                                                 Caco2.Fgut = FALSE,
                                                                 overwrite.invivo = FALSE,
                                                                 keepit100 = FALSE),
                                            output.units = "uM",
                                            calc.analytic.css.arg.list = list(
                                               IVIVE = "Honda1"),
                                         suppress.messages=TRUE)))),.(CAS)]
```
###
```{r something}

# load ToxCast Summary file
load(file = paste0(loc.wd, "/r_data/BER/toxcast_summary_15AUG2019.RData"))

# load httk-seem3 data 
load(file = paste0(loc.wd, "/r_data/BER/seem3_httk_chems_15AUG2019.RData"))

# Merge with Toxcast data and convert q5AC50 to OED (aka AED)
aed.dt <- toxcast.summary[use.dt, on = "CAS"]
aed_r1_mcaco2 <- aed.dt[, lapply(unlist(r1_mcaco2), function(x) q5cnom/x), .(CAS, DTXSID)][,c("gutabs", "IVIVE") := 
                                                                                             list("bold('Caco-2')~bolditalic('F'['bio'])", "bold('Nominal Conc.')")]
aed_r2_mfabs <- aed.dt[, lapply(unlist(r2_mfabs), function(x) q5cnom/x), .(CAS, DTXSID)][,c("gutabs", "IVIVE") := 
                                                                                           list("bolditalic('In Vivo')~bolditalic('F'['bio'])", "bold('Nominal Conc.')")]
aed_r3_mcaco2_honda1 <- aed.dt[, lapply(unlist(r1_mcaco2), function(x) q5cfree/x), .(CAS, DTXSID)][,c("gutabs", "IVIVE") := 
                                                                                                     list("bold('Caco-2')~bolditalic('F'['bio'])", "bold('Free Conc.')")]
aed_r4_mfabs_honda1 <- aed.dt[, lapply(unlist(r2_mfabs), function(x) q5cfree/x), .(CAS, DTXSID)][,c("gutabs", "IVIVE") := 
                                                                                                   list("bolditalic('In Vivo')~bolditalic('F'['bio'])", "bold('Free Conc.')")]
aed.full <- rbind(aed_r1_mcaco2,
                  aed_r2_mfabs,
                  aed_r3_mcaco2_honda1,
                  aed_r4_mfabs_honda1)
setnames(aed.full, 3:9, c("q025", "q05", "q25", "q50", "q75", "q95", "q975"))
aed.full[, gutabs := factor(gutabs, levels = c("bolditalic('In Vivo')~bolditalic('F'['bio'])","bold('Caco-2')~bolditalic('F'['bio'])"))] %>% 
  .[, IVIVE := factor(IVIVE, levels = c("bold('Nominal Conc.')", "bold('Free Conc.')"))]
aed.full2 <- seem.dt[,.(DTXSID = dsstox_substance_id, seem3, seem3.l95, seem3.u95)][aed.full, on = "DTXSID"]
aed.full3 <- aed.full2[gutabs == "bolditalic('In Vivo')~bolditalic('F'['bio'])" & IVIVE == "bold('Nominal Conc.')", .(r1 = rank(q95), CAS)][aed.full2, on = 'CAS']
aed.full4 <- aed.full3[gutabs == "bolditalic('In Vivo')~bolditalic('F'['bio'])" & IVIVE == "bold('Nominal Conc.')", .(r2 = rank(log10(q95/seem3.u95)), CAS)][aed.full3, on = 'CAS']
aed.full4[q95/seem3.u95 <= 1, cross.ber.min := max(c(q95, seem3.l95)), .(DTXSID, gutabs, IVIVE)] %>% 
  .[q95/seem3.u95 <= 1, cross.ber.max := min(c(q05, seem3.u95)), .(DTXSID, gutabs, IVIVE)]
```

### Bioactivty:Exposure Ratio Plot
```{r BER2}
# make BER plot
gtheme <- theme(axis.title = element_text(size=12,color="black",face="bold"),
                axis.text.y = element_text(size=10, color = "black",face="bold"),
                legend.text = element_text(size = 10),
                legend.title = element_text(size = 10),
                legend.key.size = unit(10, "points"),
                panel.background = element_rect(fill="white"),
                axis.line = element_line(color="black"),
                strip.background = element_blank(),
                axis.ticks.y = element_line(color="black"),
                legend.position = "top",
                axis.line.x=element_line(color="black"),
                axis.ticks.x=element_line(color="black"),
                axis.text.x = element_text(size = 10,face="bold",color="black"),
                plot.title = element_text(hjust=0,size=12,face="bold"))

legend.dt <- data.table(x = 1:3, y = 1:3, 
                        leg.labl = c("OED","Exposure", "Overlap"), 
                        leg.color = c("black", "blue", "red")) %>% 
  .[, leg.labl := factor(leg.labl, levels = c("OED","Exposure", "Overlap"))]
g1leg <- ggplot(legend.dt)+
  geom_point(aes(x = x, y = y, color = leg.labl))+
  scale_color_manual(labels = c("OED","Exposure", "Overlap"),values = c("black","blue","red"))+
  labs(color = "Value:")+
  theme_bw()+
  gtheme+
  theme(legend.position = "bottom")
gleg <- get_legend(g1leg)

aed.full4[q95/seem3.u95 <= 1,.(nlow.ber = .N), .(gutabs, IVIVE) ]
# Might need to change labl2 to reflect output from previous line
figtxt.dt <- unique(aed.full4[,.(gutabs, IVIVE)]) %>% 
  .[,labl1 := c("b)","a)", "d)", "c)")] %>% 
  .[, x1 := 0] %>% 
  .[, y1 := 5] %>% 
  .[,labl2 := paste("'N'['overlap']*': ", c("146'", "138'","206'","206'"))] %>% 
  .[, x2 := 0] %>% 
  .[, y2 := -15]
figtxt.dt
g1 <- ggplot(aed.full4)+
  facet_grid(gutabs ~ IVIVE, labeller = label_parsed)+
  geom_linerange(aes(ymin = log10(q95), ymax = log10(q05), x = r2), color = "black") +
  geom_point(aes(y = log10(q50), x = r2), color = "black") +
  geom_linerange(aes(ymin = log10(seem3.l95), ymax = log10(seem3.u95), x = r2), color = "blue") +
  geom_point(aes(y = log10(seem3), x = r2), color = "blue") +
  geom_linerange(aes(ymin = log10(cross.ber.min), ymax = log10(cross.ber.max), x = r2), color = "red")+
  geom_text(data = figtxt.dt,mapping = aes(x = x1, y = y1, label = labl1),hjust = 0, parse = FALSE)+
  geom_text(data = figtxt.dt,mapping = aes(x = x2, y = y2, label = labl2),hjust = 0, parse = TRUE)+
  labs(x = "BER Rank (panel a)", y = expression(bold('log'['10']*'(mg/kgBW/day)')))+
  theme_bw()+
  gtheme
hlay <- t(t(c(rep(1,8),2)))
g2 <- marrangeGrob(grobs = list(g1, gleg), nrow = 2, ncol = 1, top = NULL, layout_matrix = hlay)
ggsave(g2, file = paste0(loc.wd, "/r_data/results_for_paper/BERrank.tiff"), dpi = 600, height = 5, width = 7.5, compression = "lzw")
```
