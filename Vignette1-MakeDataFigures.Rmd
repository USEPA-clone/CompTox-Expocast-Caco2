---
title: "Honda et al. (unsubmitted): Caco-2 Data Organization and Analysis"
author: "Greg Honda and John Wambaugh"
date: "August 21, 2023"
output: rmarkdown::html_vignette
vignette: >
 %\VignetteIndexEntry{Honda et al. (unsubmitted): Data Organization and Analysis}
 %\VignetteEngine{knitr::rmarkdown}
 %\VignetteEncoding{UTF-8}
---
wambaugh.john@epa.gov

This vignette loads and processes the *in vitro*-measured Caco-2 membrane 
permeability data and creates
several summary plots for both reference and newly-measured chemicals. Where
possible we label data generated for pharmaceuticals separately from other,
non-pharmaceutical chemicals that might be found in commerce and the 
environment.

## Overall Manuscript Abstract
Performance of pharmacokinetic models developed using *in vitro-to-in vivo* 
extrapolation (IVIVE) methods may be improved by refining assumptions regarding 
fraction absorbed ($F_{abs}$) through the intestine, a component of oral 
bioavailability ($F_{bio}$). Although *in vivo* measures of Fabs are often 
unavailable for non-pharmaceuticals, *in vitro* measures of apparent 
permeability ($P_{app}$) using the Caco-2 cell line have been highly correlated 
with $F_{abs}$. We measured bidirectional $P_{app}$ for over 400 
non-pharmaceutical chemicals using the Caco-2 assay. A random forest 
quantitative structure-property relationship (QSPR) model was developed using 
these and peer-reviewed pharmaceutical data. Both Caco-2 data ($R^2$=0.37) and 
the QSPR model ($R^2$=0.29) were better at predicting human bioavailability 
compared to *in vivo* rat data ($R^2$=0.23). After incorporation into a high 
throughput toxicokinetics (HTTK) framework for IVIVE, the Caco-2 data were used 
to estimate in vivo administered equivalent dose (AED) for bioactivity assessed 
*in vitro*, The HTTK-predicted plasma steady state concentrations ($C_{ss}$) 
for IVIVE were revised, with modest changes predicted for poorly absorbed 
chemicals. Experimental data were evaluated for sources of measurement 
uncertainty, which were then accounted for using the Monte Carlo method. 
Revised AEDs were subsequently compared with exposure estimates to evaluate 
effects on bioactivity:exposure ratios, a surrogate for risk. Only minor 
changes in the margin between chemical exposure and predicted bioactive doses 
were observed due to the preponderance of highly absorbed chemicals. 

## Prepare for session

### Clear memory
```{r setup}
# Delete all objects from memory:
rm(list=ls())
```

### Set the figure size
```{r knitr_setup}
loc.wd <- "C:/Users/jwambaug/git/comptox-caco2/Honda_Caco2"
knitr::opts_chunk$set(echo = TRUE, fig.width=5, fig.height=4)
knitr::opts_knit$set(root.dir = loc.wd)
```

### Load the relevant libraries
```{r r_setup}

packages <- c("ggplot2", "readxl", "data.table", "dplyr",
              "scales", "ggpubr", "xlsx", "viridis")
sapply(packages, require,character.only=TRUE) #Note, the "character.only" argument is necessary her
```
### Function for labeling on log-scale:
```{r label_logscale}
scientific_10 <- function(x) {                                  
  out <- gsub("1e", "10^", scientific_format()(x))              
  out <- gsub("\\+","",out)                                     
  out <- gsub("10\\^01","10",out)                               
  out <- parse(text=gsub("10\\^00","1",out))                    
}  
```

### Plot Configuration
Here we set standard aspects of all plots, like font size.
```{r ggplot_theme}
gtheme <- theme(axis.title = element_text(size=12,color="black",face="bold"),
                axis.text.y = element_text(size=10, color = "black",face="bold"),
                legend.text = element_text(size = 10),
                legend.title = element_text(size = 10),
                legend.key.size = unit(10, "points"),
                panel.background = element_rect(fill="white"),
                axis.line = element_line(color="black"),
                axis.ticks.y = element_line(color="black"),
                legend.position = "top",
                axis.line.x=element_line(color="black"),
                axis.ticks.x=element_line(color="black"),
                axis.text.x = element_text(size = 10,face="bold",color="black"),
                plot.title = element_text(hjust=0,size=12,face="bold"))
```

### Load Various R Scripts
```{r helpful_utilities}
source(paste0(loc.wd,"/r_scripts/Honda_caco2_utilities.R"))
#source('C:/Users/GHONDA/Documents/HTTKOralRoute/gh_ionization_functions.R')
#source("C:/Users/GHONDA/Documents/R homebrew/chemprop_connect/query_dsstox.measchemprop.R")
#source(paste0(loc.wd,"/r_scripts/rf_train.R"))
#source(paste0(loc.wd,"/r_scripts/Honda_caco2_fullmodel.R"))
```

### Data Processing Functions
We calculate both with and without recovery filters (low_rec_co and high_rec_co)
```{r caco2_load_function}
load_caco_dt <- function(low_rec_co, high_rec_co)
{  
  load(paste0(loc.wd,"/r_data/caco2_qc/caco2dt_processed.RData"))
  caco2.QC <- fread(paste0(loc.wd,"/r_data/caco2_qc/caco2dt_line101_short.csv"))
  caco2.QC[,1] <- NULL

  caco2.dt <- caco2.QC[caco2.dt,on=.(test_article,dtxsid,task_order,file_id)]
  caco2.dt <- copy(caco2.dt)
  caco2.dt[, comment_ab3 := as.character(comment_ab3)] %>% 
    .[!is.na(update_Pab1),Pab1:=update_Pab1] %>% 
    .[!is.na(update_Pab2),Pab2:=update_Pab2] %>% 
    .[!is.na(update_Pab3),Pab3:=update_Pab3] %>% 
    .[!is.na(update_rec_ab1),rec_ab1:=update_rec_ab1] %>% 
    .[!is.na(update_rec_ab2),rec_ab2:=update_rec_ab2] %>% 
    .[!is.na(update_rec_ab3),rec_ab3:=update_rec_ab3] %>% 
    .[!is.na(update_Pba1),Pba1:=update_Pba1] %>% 
    .[!is.na(update_Pba2),Pba2:=update_Pba2] %>% 
    .[!is.na(update_Pba3),Pba3:=update_Pba3] %>% 
    .[!is.na(update_rec_ba1),rec_ba1:=update_rec_ba1] %>% 
    .[!is.na(update_rec_ba2),rec_ba2:=update_rec_ba2] %>% 
    .[!is.na(update_rec_ba3),rec_ba3:=update_rec_ba3] %>% 
    .[comment_ab1=="",comment_ab1:=NA_character_] %>% 
    .[comment_ab2=="",comment_ab2:=NA_character_] %>% 
    .[comment_ab3=="",comment_ab3:=NA_character_] %>%
    .[is.na(comment_ab1) & Pab1_orig=="ND",comment_ab1:="ND"] %>% 
    .[is.na(comment_ab2) & Pab2_orig=="ND",comment_ab2:="ND"] %>% 
    .[is.na(comment_ab3) & Pab3_orig=="ND",comment_ab3:="ND"] %>% 
    .[comment_ba1=="",comment_ba1:=NA_character_] %>% 
    .[comment_ba2=="",comment_ba2:=NA_character_] %>% 
    .[comment_ba3=="",comment_ba3:=NA_character_] %>%
    .[is.na(comment_ba1) & Pba1_orig=="ND",comment_ba1:="ND"] %>% 
    .[is.na(comment_ba2) & Pba2_orig=="ND",comment_ba2:="ND"] %>% 
    .[is.na(comment_ba3) & Pba3_orig=="ND",comment_ba3:="ND"] %>%
# Filtering of negative Pab:
    .[Pab1 <= 0, comment_ab1:="ND"] %>% 
    .[Pab2 <= 0, comment_ab2:="ND"] %>% 
    .[Pab3 <= 0, comment_ab3:="ND"] %>% 
    .[Pba1 <= 0, comment_ba1:="ND"] %>% 
    .[Pba2 <= 0, comment_ba2:="ND"] %>% 
    .[Pba3 <= 0, comment_ba3:="ND"] %>% 
    .[Pab1 <= 0, Pab1:=NA_real_] %>% 
    .[Pab2 <= 0, Pab2:=NA_real_] %>% 
    .[Pab3 <= 0, Pab3:=NA_real_] %>% 
    .[Pba1 <= 0, Pba1:=NA_real_] %>% 
    .[Pba2 <= 0, Pba2:= NA_real_] %>% 
    .[Pba3 <= 0, Pba3:= NA_real_] %>% 
# Filtering based on low and high recovery thresholds:
    .[!(is.na(comment_ab1)|comment_ab1 %in% c("LOD","low_rec")),Pab1:=as.numeric(NA)] %>% 
    .[is.na(rec_ab1) | rec_ab1 < low_rec_co | rec_ab1 > high_rec_co, Pab1:=as.numeric(NA)] %>% 
    .[is.na(comment_ab1) & rec_ab1 < low_rec_co, comment_ab1:="low_rec"] %>% 
    .[is.na(comment_ab1) & rec_ab1 > high_rec_co, comment_ab1:="high_rec"] %>% 
    .[!(is.na(comment_ab2)|comment_ab2 %in% c("LOD","low_rec")),Pab2:=as.numeric(NA)] %>% 
    .[is.na(rec_ab2) | rec_ab2 < low_rec_co | rec_ab2 > high_rec_co, Pab2:=as.numeric(NA)] %>% 
    .[is.na(comment_ab2) & rec_ab2 < low_rec_co, comment_ab2:="low_rec"] %>% 
    .[is.na(comment_ab2) & rec_ab2 > high_rec_co, comment_ab2:="high_rec"] %>% 
    .[!(is.na(comment_ab3)|comment_ab3 %in% c("LOD","low_rec")),Pab3:=as.numeric(NA)] %>% 
    .[is.na(rec_ab3) | rec_ab3 < low_rec_co | rec_ab3 > high_rec_co, Pab3:=as.numeric(NA)] %>% 
    .[is.na(comment_ab3) & rec_ab3 < low_rec_co, comment_ab3:="low_rec"] %>% 
    .[is.na(comment_ab3) & rec_ab3 > high_rec_co, comment_ab3:="high_rec"] %>% 
    .[!(is.na(comment_ba1)|comment_ba1 %in% c("LOD","low_rec")),Pba1:=as.numeric(NA)] %>% 
    .[is.na(rec_ba1) | rec_ba1 < low_rec_co | rec_ba1 > high_rec_co, Pba1:=as.numeric(NA)] %>% 
    .[is.na(comment_ba1) & rec_ba1 < low_rec_co, comment_ba1:="low_rec"] %>% 
    .[is.na(comment_ba1) & rec_ba1 > high_rec_co, comment_ba1:="high_rec"] %>% 
    .[!(is.na(comment_ba2)|comment_ba2 %in% c("LOD","low_rec")),Pba2:=as.numeric(NA)] %>% 
    .[is.na(rec_ba2) | rec_ba2 < low_rec_co | rec_ba2 > high_rec_co, Pba2:=as.numeric(NA)] %>% 
    .[is.na(comment_ba2) & rec_ba2 < low_rec_co, comment_ba2:="low_rec"] %>% 
    .[is.na(comment_ba2) & rec_ba2 > high_rec_co, comment_ba2:="high_rec"] %>% 
    .[!(is.na(comment_ba3)|comment_ba3 %in% c("LOD","low_rec")),Pba3:=as.numeric(NA)] %>% 
    .[is.na(rec_ba3) | rec_ba3 < low_rec_co | rec_ba3 > high_rec_co, Pba3:=as.numeric(NA)] %>% 
    .[is.na(comment_ba3) & rec_ba3 < low_rec_co, comment_ba3:="low_rec"] %>% 
    .[is.na(comment_ba3) & rec_ba3 > high_rec_co, comment_ba3:="high_rec"]
# Synthesize values across measuremnt replicates (experiment performed in triplicate:
  caco2.dt[!(is.na(rec_ab1)&is.na(rec_ab2)&is.na(rec_ab3)),
           rec_ab:=mean(c(rec_ab1,rec_ab2,rec_ab3)[!is.na(c(rec_ab1,rec_ab2,rec_ab3)) &
                                                     (c(rec_ab1,rec_ab2,rec_ab3) >= low_rec_co) &
                                                     (c(rec_ab1,rec_ab2,rec_ab3) <= high_rec_co)],na.rm=T),.(rec_ab1,rec_ab2,rec_ab3)] %>% 
    .[!(is.na(rec_ab1)&is.na(rec_ab2)&is.na(rec_ab3)),
      sd_rec_ab:=sd(c(rec_ab1,rec_ab2,rec_ab3)[!is.na(c(rec_ab1,rec_ab2,rec_ab3)) &
                                                 (c(rec_ab1,rec_ab2,rec_ab3) >= low_rec_co) &
                                                 (c(rec_ab1,rec_ab2,rec_ab3) <= high_rec_co)],na.rm=T),.(rec_ab1,rec_ab2,rec_ab3)] %>% 
    .[!(is.na(rec_ba1)&is.na(rec_ba2)&is.na(rec_ba3)),
      rec_ba:=mean(c(rec_ba1,rec_ba2,rec_ba3)[!is.na(c(rec_ba1,rec_ba2,rec_ba3)) &
                                                (c(rec_ba1,rec_ba2,rec_ba3) >= low_rec_co) &
                                                (c(rec_ba1,rec_ba2,rec_ba3) <= high_rec_co)],na.rm=T),.(rec_ba1,rec_ba2,rec_ba3)] %>% 
    .[!(is.na(rec_ba1)&is.na(rec_ba2)&is.na(rec_ba3)),
      sd_rec_ba:=sd(c(rec_ba1,rec_ba2,rec_ba3)[!is.na(c(rec_ba1,rec_ba2,rec_ba3)) &
                                                 (c(rec_ba1,rec_ba2,rec_ba3) >= low_rec_co) &
                                                 (c(rec_ba1,rec_ba2,rec_ba3) <= high_rec_co)],na.rm=T),.(rec_ba1,rec_ba2,rec_ba3)] %>% 
    .[!(is.na(Pab1)&is.na(Pab2)&is.na(Pab3)) & !(is.na(rec_ab1)&is.na(rec_ab2)&is.na(rec_ab3)),
      Pab_c:=mean(c(Pab1,Pab2,Pab3)[!is.na(c(rec_ab1,rec_ab2,rec_ab3)) &
                                      (c(rec_ab1,rec_ab2,rec_ab3) >= low_rec_co) &
                                      (c(rec_ab1,rec_ab2,rec_ab3) <= high_rec_co)],na.rm = T),.(Pab1,Pab2,Pab3)] %>% 
    .[!(is.na(Pab1)&is.na(Pab2)&is.na(Pab3)) & !(is.na(rec_ab1)&is.na(rec_ab2)&is.na(rec_ab3)),
      sd_Pab:=sd(c(Pab1,Pab2,Pab3)[!is.na(c(rec_ab1,rec_ab2,rec_ab3)) &
                                     (c(rec_ab1,rec_ab2,rec_ab3) >= low_rec_co) &
                                     (c(rec_ab1,rec_ab2,rec_ab3) <= high_rec_co)],na.rm=T),.(Pab1,Pab2,Pab3)] %>% 
    .[!(is.na(Pba1)&is.na(Pba2)&is.na(Pba3)) & !(is.na(rec_ba1)&is.na(rec_ba2)&is.na(rec_ba3)),
      Pba_c:=mean(c(Pba1,Pba2,Pba3)[!is.na(c(rec_ba1,rec_ba2,rec_ba3)) &
                                      (c(rec_ba1,rec_ba2,rec_ba3) >= low_rec_co) &
                                      (c(rec_ba1,rec_ba2,rec_ba3) <= high_rec_co)],na.rm=T),.(Pba1,Pba2,Pba3)] %>% 
    .[!(is.na(Pba1)&is.na(Pba2)&is.na(Pba3)) & !(is.na(rec_ba1)&is.na(rec_ba2)&is.na(rec_ba3)),
      sd_Pba := sd(c(Pba1,Pba2,Pba3)[!is.na(c(rec_ba1,rec_ba2,rec_ba3)) &
                                       (c(rec_ba1,rec_ba2,rec_ba3) >= low_rec_co) &
                                       (c(rec_ba1,rec_ba2,rec_ba3) <= high_rec_co)],na.rm=T),.(Pba1,Pba2,Pba3)]
  
   caco2.dt[,Pab:=Pab_c] %>% 
    .[,Pba:=Pba_c]
  caco2.dt[,batch_id:=batch_guess]  
  caco2.dt[casrn=="106-47-8",compound:="4-Chloroaniline"] %>% 
    .[casrn=="33228-44-3",compound:="4-Pentylaniline"]
  caco2.dt[casrn == "66357-35-5", c("compound", "dtxsid") := list("Ranitidine", "DTXSID8045191")] %>% 
    .[casrn == "57460-41-0", c("compound", "dtxsid") := list("Talinolol", "DTXSID6046426")] %>% 
    .[casrn == "81-81-2", c("compound", "dtxsid") := list("Warfarin", "DTXSID5023742")]
  
  caco2.dt[rec_ab < 0, rec_ab := NA_real_] %>% 
    .[rec_ba < 0, rec_ba := NA_real_]

  return(caco2.dt)
}
```
### Function to apply Frec adjustment
```{r frec_adjustment_function}
adjust_for_frec <- function(caco2.dt, Pab.thresh)
{
  caco2.dt[, Pab0 := Pab] %>% 
    .[, Pba0 := Pba] %>% 
    .[Pab>Pab.thresh, Pab := Pab/rec_ab] %>% 
    .[Pba>Pab.thresh, Pba := Pba/rec_ba] %>% 
    .[, efflux0 := Pba0/Pab0] %>% 
    .[, efflux.ratio := Pba/Pab]
  
  return (caco2.dt)
}
```

### Function to take mean across chemical replicates:
```{r merge_chemical_replicates_function}
merge_chemical_replicates <- function(caco2.dt)
{
# Calculate per chemical stats:
  caco2.perchem <- caco2.dt[,
                            .(mPab = 10^mean(log10(Pab), na.rm = T),
                              sdPab = sd(log10(Pab), na.rm = T),
                              mPba = 10^mean(log10(Pba), na.rm = T),
                              sdPba = sd(log10(Pba), na.rm = T),
                              mPab0 = 10^mean(log10(Pab0), na.rm = T),
                              sdPab0 = sd(log10(Pab0), na.rm = T),
                              mPba0 = 10^mean(log10(Pba0), na.rm = T),
                              sdPba0 = sd(log10(Pba0), na.rm = T),
                              mefflux = mean(efflux.ratio, na.rm = T),
                              sdefflux = sd(efflux.ratio, na.rm = T),
                              mefflux0 = mean(efflux0, na.rm = T),
                              sdefflux0 = sd(efflux0, na.rm = T),
                              mrec_ab = mean(rec_ab, na.rm = T),
                              mrec_ba = mean(rec_ba, na.rm = T),
                              sdrec_ab = sd(rec_ab, na.rm = T),
                              sdrec_ba = sd(rec_ba, na.rm = T),
                              ntotal_recab = sum(!is.na(rec_ab)),
                              ntotal_recba = sum(!is.na(rec_ba)),
                              ntotal = .N,
                              ntotal_ab = sum(!is.na(Pab)),
                              ntotal_ba = sum(!is.na(Pba)),
                              ntotal_efflux = sum(!is.na(log10(efflux.ratio))),
                              ntotal_rab = sum(!is.na(rec_ab)),
                              ntotal_rba = sum(!is.na(rec_ba))),
                            .(casrn, dtxsid, compound)]
  caco2.perchem <- caco2.perchem[,cvPab := sdPab/mPab]
  caco2.perchem <- caco2.perchem[,cvPab0 := sdPab0/mPab0]

  return(caco2.perchem)
}
```

## Data Analysis

### Set thresholds for low and high fractional recovery:
```{r frec_thresholds, eval=FALSE}
low_rec_co <- 0.4
high_rec_co <- 2
```


### Load raw (unfiltered) data and calculate means across replicates without filtering:

```{r load_raw}
# No cutoffs:
  caco2.unfilt <- load_caco_dt(low_rec_co=-Inf,
                               high_rec_co=Inf)
# No adjustment:
  caco2.unfilt <- adjust_for_frec(caco2.unfilt,Pab.thresh=Inf)
  caco2.perchemraw <- merge_chemical_replicates(caco2.unfilt)
  save(caco2.perchemraw, 
       file = paste0(loc.wd, 
                     "/results_for_paper/RawCaco2Data.RData"))
```

```{r rank_on_duplicates}
  caco2.dup <- caco2.unfilt
  caco2.dup[!is.na(Pab),nrep_pab := .N,.(casrn)]
  caco2.dup <- caco2.dup[nrep_pab >= 2,] %>% 
    .[,mPab := mean(Pab, na.rm=TRUE), .(casrn)]
  caco2.dup <- unique(caco2.dup[,.(mPab,casrn)])[, 
                 .(chemrank = rank(mPab),casrn)][caco2.dup, on = "casrn"]
```

### duplicate measures
```{r replicates}
  txt.dt <- unique(caco2.dup[casrn %in% 
    c("66357-35-5", "57460-41-0", "81-81-2"),
    .(compound, casrn, mPab)]) %>% 
    .[, y := 1.5*mPab] %>% 
    .[, x := 10^c(0.0025,1.5,0.25)] %>% 
    .[, hjust := c(0, 1, 0)]

  predint1 <- pred_int(x0 = log10(caco2.dup$Pab), 
                       y0 = log10(caco2.dup$mPab), alpha = 0.95)
  
  FigMeanPabvsPab <- ggplot(caco2.dup)+
    geom_point(aes(x = Pab, y = mPab), alpha = 0.5)+
    #geom_smooth(aes(x = Pab, y = mPab), method = "lm")+
    geom_abline(slope = 1, linetype = "dashed")+
    geom_ribbon(data = predint1$res.dt, 
                aes(x= 10^xn, ymin = 10^yn2, ymax = 10^yn1), 
                alpha = 0.2, fill = "blue")+
    geom_text(data = txt.dt, 
              aes(x = x, y = y, label = compound, hjust = hjust))+
    labs(y = 
           expression(bold("Mean")*bolditalic("P"["app"]^"AB")~bold('(10'^'-6'~'cm/s)')), 
         x = expression(bolditalic("P"["app"]^"AB")~bold('(10'^'-6'~'cm/s)'))) +
    scale_x_log10(labels=scientific_10)+
    scale_y_log10(labels=scientific_10)+
    theme_bw() +
    gtheme

  ggsave(FigMeanPabvsPab, file = paste0(loc.wd,
    "/results_for_paper/FigMeanPabvsPab.tiff"),
    height = 3, width = 3, dpi = 600, compression = "lzw")
  print(FigMeanPabvsPab)
```
### Analysis of Raw Data

```{r make_recovery_fraction_histograms}
  load(file = paste0(loc.wd, 
                     "/results_for_paper/RawCaco2Data.RData"))

labl.dt1 <- data.table(x = 2, y = c(150, 125, 100),
                       labl = c(paste0("Mean: ", signif(mean(caco2.perchemraw[, mrec_ab], na.rm = T),2)),
                                paste0("SD: ", signif(sd(caco2.perchemraw[, mrec_ab], na.rm = T),2)),
                                paste0("Total Count: ", sum(caco2.perchemraw[, !is.na(mrec_ab) & mrec_ab > 0]))
                                ))
labl.dt2 <- data.table(x = 2, y = c(150, 125, 100),
                       labl = c(paste0("Mean: ", signif(mean(caco2.perchemraw[, mrec_ba], na.rm = T),2)),
                                paste0("SD: ", signif(sd(caco2.perchemraw[, mrec_ba], na.rm = T),2)),
                                paste0("Total Count: ", sum(caco2.perchemraw[, !is.na(mrec_ba) & mrec_ba > 0]))
                       ))

FigFrecabHist <- 
  ggplot(caco2.perchemraw[mrec_ab > 0,])+
  geom_histogram(aes(x = mrec_ab), fill= "grey80", color = "black")+
  geom_vline(xintercept = 1, linetype = "dashed")+
  geom_text(data = labl.dt1, aes(x = x, y = y, label = labl), hjust = 0)+
  labs(#title = "a)",
    y = expression(bold("Count")), 
    x = expression(bolditalic("F")[bolditalic("rec")]^bolditalic("AB"))) +
  #lims(x = c(0,2.1), y = c(0,85))+
  scale_x_continuous(limits = c(0, 5), breaks = c(0,1,2,3,4), expand = c(0,0))+
  scale_y_continuous(limits = c(0,200))+
  theme_bw()+
  gtheme+
  annotation_custom(grob = text_grob("a)", hjust = 0, size = 12, face = "bold"),
                    ymin = 195,ymax = 195,xmax = 0.1, xmin = 0.1)

FigFrecbaHist <- 
  ggplot(caco2.perchemraw[mrec_ba > 0,])+
  geom_histogram(aes(x = mrec_ba), fill= "grey80", color = "black")+
  geom_vline(xintercept = 1, linetype = "dashed")+
  geom_text(data = labl.dt2, aes(x = x, y = y, label = labl), hjust = 0)+
  labs(#title = "Talinolol",
    y = expression(bold("Count")), 
    x = expression(bolditalic("F")[bolditalic("rec")]^bolditalic("BA"))) +
  scale_x_continuous(limits = c(0, 5), breaks = c(0,1,2,3,4), expand = c(0,0))+
  scale_y_continuous(limits = c(0,200))+
  #lims(x = c(0,2.1), y = c(0,85))+
  theme_bw()+
  gtheme+
  annotation_custom(grob = text_grob("b)", hjust = 0, size = 12, face = "bold"), 
                    ymin = 195,ymax = 195,xmax = 0.1, xmin = 0.1)

ggsave(FigFrecabHist, file = paste0(loc.wd, "/results_for_paper/Fig_mrec_ab_histo.tiff"),
       height = 3, width = 3, dpi = 600, compression = "lzw")
ggsave(FigFrecbaHist, file = paste0(loc.wd, "/results_for_paper/Fig_mrec_ba_histo.tiff"),
       height = 3, width = 3, dpi = 600, compression = "lzw")
print(FigFrecabHist)
print(FigFrecbaHist)
```
```{r chemical_counts}
  load(file = paste0(loc.wd, 
                     "/results_for_paper/RawCaco2Data.RData"))

Num.positive.frec.ab <- length(unique(subset(caco2.perchemraw, 
                                             mrec_ab > 0)$dtxsid))
Num.positive.frec.ba <- length(unique(subset(caco2.perchemraw, 
                                             mrec_ba > 0)$dtxsid))
Num.chems <- length(unique(caco2.perchemraw$dtxsid))

cat(paste("The Caco-2 assay was attempted for ",
          Num.chems,
          " chemicals. Of these, ",
          Num.positive.frec.ab,
          " chemicals had a measurable PappAB (apical to basolateral) and ",
          Num.positive.frec.ba,
          " had a measurable PappBA.\n",sep="")) 
```

### Reload data using cutoffs based on fraction recovered (Frec):
```{r load_filtered}
# Low and high cutoffs:
  caco2.filt <- load_caco_dt(low_rec_co=0.4,
                               high_rec_co=2)
```

```{r chemical_counts_filtered}
Num.good.Pab <- length(unique(subset(caco2.filt, 
                                             !is.na(Pab))$dtxsid))
Num.good.Pba <- length(unique(subset(caco2.filt, 
                                             !is.na(Pba))$dtxsid))
Num.chems.either <- length(unique(subset(caco2.filt,
                                   !is.na(Pab) |
                                             !is.na(Pba))$dtxsid))
Num.chems.both <- length(unique(subset(caco2.filt,
                                   !is.na(Pab) &
                                             !is.na(Pba))$dtxsid))

cat(paste("After filtering by Frec, there were a total of ",
          Num.chems.either,
          " chemicals that had either PappAB or PappBA and ",
          Num.chems.both,
          " that had both. Of these, ",
          Num.good.Pab,
          " chemicals had usable PappAB and ",
          Num.good.Pba,
          " had a usable PappBA.\n",sep="")) 
```
## Analysis of Filtered Data

### Stats on adjusting Pab for fraction recovered:
```{r frec_adjustment_stats}
Pab.thresh <- 10

  lmstat1 <- summary(lm(Pab ~ rec_ab, data =
                          subset(caco2.filt,Pab>Pab.thresh)))
  lmstat2 <- summary(lm(Pab/rec_ab ~ rec_ab, data =
                          subset(caco2.filt,Pab>Pab.thresh)))
  lmstat3 <- summary(lm(Pba ~ rec_ba, data =
                          subset(caco2.filt,Pba>Pab.thresh)))
  lmstat4 <- summary(lm(Pba/rec_ba ~ rec_ba, data =
                          subset(caco2.filt,Pba>Pab.thresh)))

# Create labels for figures:
  labl.dt1 <- data.table(x = 0.5,
                         y = c(120,100),
                         labl = c("p*'-'*value:~'<'~0.001",
                                  paste0("R^2: ", signif(lmstat1$r.squared,2))))
  labl.dt2 <- data.table(x = 0.5,
                         y = c(120,100),
                         labl = c(paste0("p*'-'*value: ", signif(lmstat2$coefficients[2,4],2)),
                                  paste0("R^2: ", signif(lmstat2$r.squared,2))))
  labl.dt3 <- data.table(x = 0.5,
                         y = c(120,100),
                         labl = c("p*'-'*value:~'<'~0.001",
                                  paste0("R^2: ", signif(lmstat3$r.squared,2))))
  labl.dt4 <- data.table(x = 0.5,
                         y = c(120,100),
                         labl = c(paste0("p*'-'*value: ", signif(lmstat2$coefficients[2,4],2)),
                                  paste0("R^2: ", signif(lmstat4$r.squared,2))))
```

# Divide Papp values > 0 by Frec
We have chosen to not use a Pab.threshold (value of 10 used in Sup Fig 1), but
0 used for data processing:
```{r adjustforrecovery}
  caco2.filt <- adjust_for_frec(caco2.filt, 
                                  Pab.thresh=0)
```

### recovery vs permeability graphs - S1
```{r make_recovery_adjustment_figures}
  FigPabvsRecovery <- ggplot(caco2.filt) +
    geom_point(aes(x = rec_ab, y = Pab0), 
               fill = "grey90", color = "black",
               size = 3, shape = 16, alpha = 0.5) +
    geom_smooth(aes(x = rec_ab, y = Pab0), data=
                      subset(caco2.filt,Pab0>Pab.thresh), method = "lm")+
    geom_text(data = labl.dt1,aes(x = x, y=y, label = labl), parse = T, hjust = 0)+
    labs(x = expression(bolditalic("F")[bolditalic("rec")]^bolditalic("AB")), 
         y = expression(bolditalic("P"["app"]^"AB")~bold('(10'^'-6'~'cm/s)'))) +
    lims(x=c(0,2.5),y=c(0,200))+
    theme_bw()+
    gtheme#+
#    annotation_custom(grob = text_grob("a)", hjust = 0, size = 12, face = "bold"), 
#                      ymin = 150,ymax = 150,xmax = 0.4, xmin = 0.4)
  print(FigPabvsRecovery)
  
  FigAdjPabvsRecovery <- ggplot(caco2.filt) +
    geom_point(aes(x = rec_ab, y = Pab), 
               fill = "grey90", color = "black",
               size = 3, shape = 16, alpha = 0.5) +
    geom_smooth(aes(x = rec_ab, y = Pab), method = "lm")+
    geom_text(data = labl.dt2,aes(x = x, y=y, label = labl), parse = T, hjust = 0)+
    lims(y = c(0,150))+
    labs(x = expression(bolditalic("F")[bolditalic("rec")]^bolditalic("AB")), 
         y = expression(bolditalic("P"["app"]^"AB")~bold('(10'^'-6'~'cm/s)'))) +
    theme_bw()+
    gtheme#+
  #  annotation_custom(grob = text_grob("a)", hjust = 0, size = 12, face = "bold"), 
  #                    ymin = 150,ymax = 150,xmax = 0.4, xmin = 0.4)
  
  FigPbavsRecovery <- ggplot(caco2.filt) +
    geom_point(aes(x = rec_ba, y = Pba0), 
               fill = "grey90", color = "black",
               size = 3, shape = 16, alpha = 0.5) +
    geom_smooth(aes(x = rec_ba, y = Pba0), data=
                      subset(caco2.filt,Pba0>Pab.thresh), method = "lm")+
    geom_text(data = labl.dt3,aes(x = x, y=y, label = labl), parse = T, hjust = 0)+
    lims(y= c(0,160))+
    labs(x = expression(bolditalic("F")[bolditalic("rec")]^bolditalic("BA")),
         y = expression(bolditalic("P"["app"]^"BA")~bold('(10'^'-6'~'cm/s)'))) +
    theme_bw()+
    gtheme#+
  #  annotation_custom(grob = text_grob("b)", hjust = 0, size = 12, face = "bold"), 
 #                     ymin = 150,ymax = 150,xmax = 0.4, xmin = 0.4)
  print(FigPbavsRecovery)
  
  FigAdjPbavsRecovery <- ggplot(caco2.filt) +
    geom_point(aes(x = rec_ba, y = Pba), 
               fill = "grey90", color = "black",
               size = 3, shape = 16, alpha = 0.5) +
    geom_smooth(aes(x = rec_ba, y = Pba), method = "lm")+
    geom_text(data = labl.dt4,aes(x = x, y=y, label = labl), parse = T, hjust = 0)+
    lims(y = c(0,160))+
    labs(x = expression(bold("Recovery")[bolditalic("BA")]), 
         y = expression(bolditalic("P"["app"]^"BA")~bold('(10'^'-6'~'cm/s)'))) +
    theme_bw()+
    gtheme#+
  #  annotation_custom(grob = text_grob("b)", hjust = 0, size = 12, face = "bold"), 
  #                    ymin = 150,ymax = 150,xmax = 0.4, xmin = 0.4)
  
  ggsave(FigPabvsRecovery, file = paste0(loc.wd, "/results_for_paper/Fig_recab_v_Pab1.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
  ggsave(FigAdjPabvsRecovery, file = paste0(loc.wd, "/results_for_paper/Fig_recab_v_Pab2.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
  ggsave(FigPbavsRecovery, file = paste0(loc.wd, "/results_for_paper/Fig_recba_v_Pba1.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
  ggsave(FigAdjPbavsRecovery, file = paste0(loc.wd, "/results_for_paper/Fig_recba_v_Pba2.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```



```{r store_unflitered}
caco2.filt[, Pab.unadj.unfilt := caco2.unfilt$Pab0] %>% 
  .[, Pba.unadj.unfilt := caco2.unfilt$Pba0] %>% 
  .[, efflux.unadj.unfilt := caco2.unfilt$Pba0/caco2.unfilt$Pab0] %>% 
  .[, rec_ab.unfilt := caco2.unfilt$rec_ab] %>% 
  .[, rec_ba.unfilt := caco2.unfilt$rec_ba]
```

```{r write_final_data}
dim(unique(caco2.filt[,.(casrn, batch_id, t_type)]))
caco2.publish <- caco2.filt[,.(casrn, batch_id, t_type,
                               Pab.unadj.unfilt,
                               Pba.unadj.unfilt,
                               efflux.unadj.unfilt,
                               rec_ab.unfilt,
                               rec_ba.unfilt)][caco2.filt, 
                                               on = c("casrn", 
                                                      "batch_id", 
                                                      "t_type")]

caco2.publish[, Pab.unadj := Pab0] %>% 
  .[, Pba.unadj := Pba0] %>% 
  .[, efflux.unadj := efflux0]

# Identify the results that were filtered out:
caco2.publish[,"Filtered"] <- ""
caco2.publish[!is.na(Pab.unadj.unfilt) & is.na(Pab.unadj),"Filtered"] <- "Y"

setcolorder(caco2.publish,
            c("compound","casrn","dtxsid","batch_id","t_type",
              "Pab", "Pba", "efflux.ratio", "rec_ab", "rec_ba",
              "Pab.unadj", "Pba.unadj", "efflux.unadj",
              "Pab.unadj.unfilt", "Pba.unadj.unfilt", "efflux.unadj.unfilt",
              "rec_ab.unfilt", "rec_ba.unfilt"))
caco2.publish[, casrn := paste0(" ", casrn)]
write.xlsx(caco2.publish, 
           file = paste0(loc.wd, "/results_for_paper/caco2_data.xlsx"),
           showNA=FALSE)
save(caco2.publish, file = paste0(loc.wd,"/r_data/processed/our_caco2.RData"))

length(unique(caco2.publish[!is.na(casrn),casrn])) #484
caco2.all <- caco2.filt[,.(mPab = mean(Pab,na.rm = T),
                           mPba = mean(Pba, na.rm = T)),
                        .(casrn)]
caco2.all[,.N,.(is.na(mPab))] #423
caco2.all[,.N,.(is.na(mPba))] #453
length(unique(caco2.publish[!is.na(Pab), casrn])) # 310
length(unique(caco2.publish[!is.na(Pba), casrn])) # 396
length(unique(caco2.publish[!is.na(Pba) & !is.na(Pab), casrn])) # 302
```

```{r analyze_all_data}

# batch control pab vs upper and lower 5th percentiles - S2

  names(caco2.publish)
  caco2.5perc <- copy(caco2.publish)
  s2.dt <- caco2.5perc[, hcPab := Pab[casrn == "81-81-2" & t_type == "control"], .(batch_id)] %>% 
    .[, lcPab := Pab[casrn == "66357-35-5" & t_type == "control"], .(batch_id)] %>% 
    .[, Pab95 := quantile(Pab[t_type != "control"], 0.95, na.rm = TRUE), .(batch_id)] %>% 
    .[, Pab05 := quantile(Pab[t_type != "control"], 0.05, na.rm = TRUE), .(batch_id)] %>% 
    .[,.(hcPab, lcPab, Pab95, Pab05, batch_id)] %>% 
    unique(.)
  
  FigMeanPabvsPab <- ggplot(s2.dt) +
    geom_point(aes(x = hcPab, y = Pab95), 
               fill = "grey90", color = "black",
               size = 3, shape = 16, alpha = 0.5) +
    labs(x = expression(bold("Warfarin log"["10"])*bolditalic("P"["app"]^"AB")~bold('(10'^'-6'~'cm/s)')), 
         y = expression(bold("95%")~bold("log"["10"])*bolditalic("P"["app"]^"AB")~bold('(10'^'-6'~'cm/s)'))) +
    theme_bw()+
    gtheme
  #print(g1)
  ggsave(FigMeanPabvsPab, file = paste0(loc.wd, "/results_for_paper/Fig_MeanPabvsPAb.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
```

```{r calculate_stats_per_chemical_on_filtered_data}  
  caco2.perchem <- merge_chemical_replicates(caco2.filt)
# This table has one row per chemical:
  save(caco2.perchem,
       file = paste0(loc.wd, "/r_data/processed/MeanChemicalMeasurements.RData"))
```

```{r basic_stats}
load(file = paste0(loc.wd, "/r_data/processed/MeanChemicalMeasurements.RData"))
cat(paste("Across the newly measured chemicals the mean Pab was ",
          signif(mean(caco2.perchem$mPab,na.rm=TRUE),2),
          " 10-6 cm/s, the median was ",
          signif(median(caco2.perchem$mPab,na.rm=TRUE),2),
          ", the min was ",
          signif(min(caco2.perchem$mPab,na.rm=TRUE),2),
          ", and the max was ",
          signif(max(caco2.perchem$mPab,na.rm=TRUE),2),
          ".\n",sep=""))
```

```{r analyze_controls_warfarin}
  min(caco2.publish[casrn %in% "81-81-2",.(Pab,Pba,Pab0,Pba0)], na.rm = T)
  max(caco2.publish[casrn == " 81-81-2",.(Pab,Pba,Pab0,Pba0)], na.rm = T)
  labl.FigWarfarinPabAdj <- caco2.perchem[casrn == "81-81-2",.(labl = c(
    paste0("Mean: ",signif(mPab,2)),
    paste0("SD: ", signif(sdPab,2)),
   # paste0("CV: ", signif(cvPab,2)),
    paste0("Total Count: ", ntotal_ab)),
                                                   x = 4,
                                                   y = 0+c(13,11,9#,7
                                                         ))]
  labl.FigWarfarinPabUnadj <- caco2.perchem[casrn == "81-81-2",.(labl = c(
    paste0("Mean: ",signif(mPab0,2)),
    paste0("SD: ", signif(sdPab0,2)),
   # paste0("CV: ", signif(cvPab0,2)),
    paste0("Total Count: ", ntotal_ab)),
                                                   x = 1,
                                                   y = -4+c(13,11,9#,10
                                                              ))]
  labl.FigWarfarinPbaAdjHist <- caco2.perchem[casrn == "81-81-2",.(labl = c(
    paste0("Mean: ",signif(mPba,2)),
    paste0("SD: ", signif(sdPba,2)),
    paste0("Total Count: ", ntotal_ba)),
                                                 x = 4,
                                                 y = c(8,7,6)-1)]
  labl.FigWarfarinEffluxRAdjHist <- caco2.perchem[casrn == "81-81-2",.(labl = c(
    paste0("Mean: ",signif(mefflux,2)),
    paste0("SD: ", signif(sdefflux,2)),
    paste0("Total Count: ", ntotal_efflux)),
                                                 x = 0.1,
                                                 y = c(8,7,6))]
  
  labl.FigWarfarinFrecabHist <- caco2.perchem[casrn == "81-81-2",.(labl = c(
    paste0("Mean: ",signif(mrec_ab,2)),
    paste0("SD: ", signif(sdrec_ab,2)),
    paste0("Total Count: ", ntotal_recab
                                                              )),
                                                     x = 1.1,
                                                     y = c(7,6,5))]
  labl.FigWarfarinFrecbaHist <- caco2.perchem[casrn == "81-81-2",.(labl = c(
    paste0("Mean: ",signif(mrec_ba,2)),
    paste0("SD: ", signif(sdrec_ba,2)),
    paste0("Total Count: ", ntotal_recba
                                                              )),
                                                     x = 1.1,
                                                     y = c(10,8,6))]
  FigWarfarinPabAdjHist <- ggplot(caco2.publish[casrn == " 81-81-2",])+
    geom_histogram(aes(x = Pab), fill= "grey80", color = "black")+
    geom_text(data = labl.FigWarfarinPabAdj,
              aes(x = x, y= y, label = labl), hjust = 0)+
    labs(title = "Warfarin",
         y = expression(bold("Count")), 
         x = expression(bolditalic("P"["app"]^"AB")~bold('(10'^'-6'~'cm/s)'))) +
    scale_x_log10(labels=scientific_10,limits=c(10^0.5,10^2.5))+
    scale_y_continuous(breaks = c(0, 5, 10, 15))+
    theme_bw()+
    gtheme
  print(FigWarfarinPabAdjHist)
  
  FigWarfarinPabUnadjHist <- ggplot(caco2.publish[casrn == " 81-81-2",])+
    geom_histogram(aes(x = Pab0), fill= "grey80", color = "black")+
    geom_text(data = labl.FigWarfarinPabUnadj,
              aes(x = x, y= y, label = labl), hjust = 0)+
    labs(title = "Warfarin",
         y = expression(bold("Count")), 
         x = expression(bolditalic("P"["app"]^"AB")~bold('(10'^'-6'~'cm/s)'))) +
    scale_x_log10(labels=scientific_10,limits=c(10^-0.5,10^2.5))+
    scale_y_continuous(breaks = c(0,5,10), limits = c(0,10))+
    theme_bw()+
    gtheme
  print(FigWarfarinPabUnadjHist)
  
  FigWarfarinPbaAdjHist <- ggplot(caco2.publish[casrn == " 81-81-2",])+
    geom_histogram(aes(x = Pba), fill= "grey80", color = "black")+
    geom_text(data = labl.FigWarfarinPbaAdjHist,aes(x = x, y= y, label = labl), hjust = 0)+
    labs(title = "Warfarin",
         y = expression(bold("Count")), 
         x = expression(bolditalic("P"["app"]^"BA")~bold('(10'^'-6'~'cm/s)'))) +
    scale_x_log10(labels=scientific_10,limits=c(10^0.5,10^1.75))+
    theme_bw()+
    gtheme
  #print(g3b)
  
  FigWarfarinPbaUnadjHist <- ggplot(caco2.publish[casrn == " 81-81-2",])+
    geom_histogram(aes(x = Pba0), fill= "grey80", color = "black")+
    labs(title = "Warfarin",
         y = expression(bold("Count")), 
         x = expression(bolditalic("P"["app"]^"BA")~bold('(10'^'-6'~'cm/s)'))) +
    lims(y = c(0, 12))+
    scale_x_log10(labels=scientific_10,limits=c(10^-0.5,10^2.5))+
    theme_bw()+
    gtheme
  
  FigWarfarinEffluxRAdjHist <- ggplot(caco2.publish[casrn == " 81-81-2",])+
    geom_histogram(aes(x = efflux.ratio), fill= "grey80", color = "black")+
    geom_text(data = labl.FigWarfarinEffluxRAdjHist, aes(x = x, y= y, label = labl), hjust = 0)+
    labs(title = "Warfarin",
         y = expression(bold("Count")), 
         x = expression(bold("Efflux Ratio"))) +
    #lims(x = c(0.75,2.25))+
    scale_x_log10(labels=scientific_10)+
    theme_bw()+
    gtheme
  
  FigWarfarinEffluxRUnadjHist <- ggplot(caco2.publish[casrn == " 81-81-2",])+
    geom_histogram(aes(x =efflux0), fill= "grey80", color = "black")+
    labs(title = "Warfarin",
         y = expression(bold("Count")), 
         x = expression(bold("Efflux Ratio"))) +
    #lims(x = c(0.75,2.25))+
    scale_x_log10(labels=scientific_10)+
    theme_bw()+
    gtheme
  
  FigWarfarinFrecabHist <- 
    ggplot(caco2.publish[casrn == " 81-81-2",])+
    geom_histogram(aes(x = rec_ab), fill= "grey80", color = "black")+
    geom_text(data = labl.FigWarfarinFrecabHist, 
              aes(x = x, y= y, label = labl), hjust = 0)+
    labs(title = "Warfarin",
         y = expression(bold("Count")), 
         x = expression(bolditalic("F")[bolditalic("rec")]^bolditalic("AB"))) +
    lims(x = c(0,2.2))+
    theme_bw()+
    gtheme
  
  FigWarfarinFrecbaHist <- 
    ggplot(caco2.publish[casrn == " 81-81-2",])+
    geom_histogram(aes(x = rec_ba), fill= "grey80", color = "black")+
    geom_text(data = labl.FigWarfarinFrecbaHist, aes(x = x, y= y, label = labl), hjust = 0)+
    labs(title = "Warfarin",
         y = expression(bold("Count")), 
         x = expression(bolditalic("F")[bolditalic("rec")]^bolditalic("BA"))) +
    lims(x = c(0,2.2))+
    theme_bw()+
    gtheme
  
  ggsave(FigWarfarinPabAdjHist, file = paste0(loc.wd,
    "/results_for_paper/Fig_warfarin_Pab_histo.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
  ggsave(FigWarfarinPbaAdjHist, file = paste0(loc.wd,
    "/results_for_paper/Fig_warfarin_Pba_histo.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
  ggsave(FigWarfarinEffluxRAdjHist, file = paste0(loc.wd,
    "/results_for_paper/Fig_warfarin_efflux_histo.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
  ggsave(FigWarfarinFrecabHist, file = paste0(loc.wd,
    "/results_for_paper/Fig_warfarin_recab_histo.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
  ggsave(FigWarfarinFrecbaHist, file = paste0(loc.wd,
    "/results_for_paper/Fig_warfarin_recba_histo.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
  ggsave(FigWarfarinPabUnadjHist, file = paste0(loc.wd,
    "/results_for_paper/Fig_warfarin_Pab0_histo.tiff"),
    height = 3, width = 3, dpi = 600, compression = "lzw")
  # ggsave(g4b, file = paste0(loc.wd, "/results_for_paper/warfarin_Pba0_histo.tiff"),
  #        height = 3, width = 3, dpi = 600, compression = "lzw")
  # ggsave(g4c, file = paste0(loc.wd, "/results_for_paper/warfarin_efflux0_histo.tiff"),
  #        height = 3, width = 3, dpi = 600, compression = "lzw")
```

```{r analyze_controls_talinolol}
  labl.dtFigTalinololPabAdj <- caco2.perchem[casrn == "57460-41-0",.(labl = c(
    paste0("Mean: ",signif(mPab,2)),
    paste0("SD: ", signif(sdPab,2)),
    #paste0("CV: ", signif(cvPab,2)),
    paste0("Total Count: ", ntotal_ab)),
                                                   x = 0.001,
                                                   y = -1+c(9.5,8.5,7.5#,6.5
                                                         ))]
  labl.dtFigTalinololPabUnadj <- caco2.perchem[casrn == "57460-41-0",.(labl = c(
    paste0("Mean: ",signif(mPab0,2)),
    paste0("SD: ", signif(sdPab0,2)),
   # paste0("CV: ", signif(cvPab0,2)),
    paste0("Total Count: ", ntotal_ab)),
                                                   x = 0.001,
                                                   y = -1+c(9.5,8.5,7.5#,6.5
                                                         ))]
  labl.FigTalinololPbaAdjHist <- caco2.perchem[casrn == "57460-41-0",.(labl = c(
    paste0("Mean: ",signif(mPba,2)),
    paste0("SD: ", signif(sdPba,2)),
    paste0("Total Count: ", ntotal_ba)),
                                                    x = 0.1,
                                                    y = c(7.5,6.5,5.5))]
  labl.FigTalinololEffluxRAdjHist <- caco2.perchem[casrn == "57460-41-0",.(labl = c(
    paste0("Mean: ",signif(mefflux,2)),
    paste0("SD: ", signif(sdefflux,2)),
    paste0("Total Count: ", ntotal_efflux)),
                                                    x = 1,
                                                    y = -2+c(7.5,6.5,5.5))]
  
  labl.FigTalinololFrecabHist <- caco2.perchem[casrn == "57460-41-0",.(labl = c(
    paste0("Mean: ",signif(mrec_ab,2)),
    paste0("SD: ", signif(sdrec_ab,2)),
    paste0("Total Count: ", ntotal_recab
                                                              )),
                                                     x = 1.1,
                                                     y = c(10,8,6))]
  labl.FigTalinololFrecbaHist <- caco2.perchem[casrn == "57460-41-0",.(labl = c(
    paste0("Mean: ",signif(mrec_ba,2)),
    paste0("SD: ", signif(sdrec_ba,2)),
    paste0("Total Count: ", ntotal_recba
                                                              )),
                                                     x = 1.1,
                                                     y = c(10,8,6))]
  
  FigTalinololPabAdjHist <- ggplot(caco2.publish[casrn == " 57460-41-0",])+
    geom_histogram(aes(x = Pab), fill= "grey80", color = "black")+
    geom_text(data = labl.dtFigTalinololPabAdj, 
              aes(x = x, y= y, label = labl), hjust = 0)+
    labs(title = "Talinolol",
         y = expression(bold("Count")), 
         x = expression(bolditalic("P"["app"]^"AB")~bold('(10'^'-6'~'cm/s)'))) +
    scale_y_continuous(breaks = c(0,5,10), limits = c(0,10))+
    scale_x_log10(labels=scientific_10,limits=c(10^-3,10^0.5))+
    theme_bw()+
    gtheme
  print(FigTalinololPabAdjHist)
  
  FigTalinololPabUnadjHist <- ggplot(caco2.publish[casrn == " 57460-41-0",])+
    geom_histogram(aes(x = Pab0), fill= "grey80", color = "black")+
    geom_text(data = labl.dtFigTalinololPabUnadj, 
              aes(x = x, y= y, label = labl), hjust = 0)+
    labs(title = "Talinolol",
         y = expression(bold("Count")), 
         x = expression(bolditalic("P"["app"]^"AB")~bold('(10'^'-6'~'cm/s)'))) +
    lims(x = c(-2.5,0.5))+
    scale_x_log10(labels=scientific_10,limits=c(10^-3,10^0.5))+
    theme_bw()+
    gtheme
  print(FigTalinololPabUnadjHist)
  
  FigTalinololPbaAdjHist <- ggplot(caco2.publish[casrn == " 57460-41-0",])+
    geom_histogram(aes(x = Pba), fill= "grey80", color = "black")+
    geom_text(data = labl.FigTalinololPbaAdjHist, aes(x = x, y= y, label = labl), hjust = 0)+
    labs(title = "Talinolol",
         y = expression(bold("Count")), 
         x = expression(bolditalic("P"["app"]^"BA")~bold('(10'^'-6'~'cm/s)'))) +
    scale_x_log10(labels=scientific_10,limits=c(10^-1,10^2.5))+
    theme_bw()+
    gtheme
  
  FigTalinololPbaUnadjHist  <- ggplot(caco2.publish[casrn == " 57460-41-0",])+
    geom_histogram(aes(x = Pba0), fill= "grey80", color = "black")+
    labs(title = "Talinolol",
         y = expression(bold("Count")), 
         x = expression(bolditalic("P"["app"]^"BA")~bold('(10'^'-6'~'cm/s)'))) +
    scale_x_log10(labels=scientific_10,limits=c(10^-1,10^2.5))+
    theme_bw()+
    gtheme
  
  FigTalinololEffluxRAdjHist <- ggplot(caco2.publish[casrn == " 57460-41-0",])+
    geom_histogram(aes(x = efflux.ratio), fill= "grey80", color = "black")+
    geom_text(data = labl.FigTalinololEffluxRAdjHist, 
              aes(x = x, y= y, label = labl), hjust = 0)+
    labs(title = "Talinolol",
         y = expression(bold("Count")), 
         x = expression(bold("Efflux Ratio"))) +
    #lims(x = c(0.75,2.25))+
    scale_x_log10(labels=scientific_10)+
    theme_bw()+
    gtheme
  
  FigTalinololEffluxRUnadjHist <- ggplot(caco2.publish[casrn == " 57460-41-0",])+
    geom_histogram(aes(x = efflux0), fill= "grey80", color = "black")+
    labs(title = "Talinolol",
         y = expression(bold("Count")), 
         x = expression(bold("Efflux Ratio"))) +
    #lims(x = c(0.75,2.25))+
    scale_x_log10(labels=scientific_10)+
    theme_bw()+
    gtheme
  
  FigTalinololFrecabHist <- 
    ggplot(caco2.publish[casrn == " 57460-41-0",])+
    geom_histogram(aes(x = rec_ab), fill= "grey80", color = "black")+
    geom_text(data = labl.FigTalinololFrecabHist, 
              aes(x = x, y= y, label = labl), hjust = 0)+
    labs(title = "Talinolol",
         y = expression(bold("Count")), 
         x = expression(bolditalic("F")[bolditalic("rec")]^bolditalic("AB"))) +
    lims(x = c(0,2.2))+
    theme_bw()+
    gtheme
  
  FigTalinololFrecbaHist <- 
    ggplot(caco2.publish[casrn == " 57460-41-0",])+
    geom_histogram(aes(x = rec_ba), fill= "grey80", color = "black")+
    geom_text(data = labl.FigTalinololFrecbaHist, 
              aes(x = x, y= y, label = labl), hjust = 0)+
    labs(title = "Talinolol",
         y = expression(bold("Count")), 
         x = expression(bolditalic("F")[bolditalic("rec")]^bolditalic("BA"))) +
    lims(x = c(0,2.2))+
    theme_bw()+
    gtheme
  
  ggsave(FigTalinololPabAdjHist, file = paste0(loc.wd,
    "/results_for_paper/Fig_Talinolol_Pab_histo.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
  ggsave(FigTalinololPbaAdjHist, file = paste0(loc.wd,
    "/results_for_paper/Fig_Talinolol_Pba_histo.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
  ggsave(FigTalinololEffluxRAdjHist, file = paste0(loc.wd,
    "/results_for_paper/Fig_Talinolol_efflux_histo.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
    ggsave(FigTalinololFrecabHist, file = paste0(loc.wd,
      "/results_for_paper/Fig_Talinolol_recab_histo.tiff"),
           height = 3, width = 3, dpi = 600, compression = "lzw")
  ggsave(FigTalinololFrecbaHist, file = paste0(loc.wd,
    "/results_for_paper/Fig_Talinolol_recba_histo.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
  
  ggsave(FigTalinololPabUnadjHist, file = paste0(loc.wd,
    "/results_for_paper/Fig_Talinolol_Pab0_histo.tiff"),
          height = 3, width = 3, dpi = 600, compression = "lzw")
  # ggsave(g4b, file = paste0(loc.wd, "/results_for_paper/Talinolol_Pba0_histo.tiff"),
  #        height = 3, width = 3, dpi = 600, compression = "lzw")
  # ggsave(g4c, file = paste0(loc.wd, "/results_for_paper/Talinolol_efflux0_histo.tiff"),
  #        height = 3, width = 3, dpi = 600, compression = "lzw")
```

```{r analyze_controls_ranitidine}
  labl.dtFigRanitidinePabAdjHist <- 
  caco2.perchem[casrn == "66357-35-5",.(labl = c(
    paste0("Mean: ",signif(mPab,2)),
    paste0("SD: ", signif(sdPab,2)),
   # paste0("CV: ", signif(cvPab,2)),
    paste0("Total Count: ", ntotal_ab)),
                                                   x = 0.01,
                                                   y = 0+c(8,7,6#,5
                                                           ))]
  labl.dtFigRanitidinePabUnadjHist <- 
  caco2.perchem[casrn == "66357-35-5",.(labl = c(
    paste0("Mean: ",signif(mPab0,2)),
    paste0("SD: ", signif(sdPab0,2)),
  #  paste0("CV: ", signif(cvPab0,2)),
    paste0("Total Count: ", ntotal_ab)),
                                                   x = 0.01,
                                                   y = -1+c(8,7,6#,5
                                                           ))]
  labl.FigRanitidinePbaAdjHist <- caco2.perchem[casrn == "66357-35-5",.(labl = c(
    paste0("Mean: ",signif(mPba,2)),
    paste0("SD: ", signif(sdPba,2)),
    paste0("Total Count: ", ntotal_ba
                                                             )),
                                                    x = 0.1,
                                                    y = c(7,6,5))]
  labl.FigRanitidineEffluxRAdjHist <- caco2.perchem[casrn == "66357-35-5",.(labl = c(
    paste0("Mean: ",signif(mefflux,2)),
    paste0("SD: ", signif(sdefflux,2)),
    paste0("Total Count: ", ntotal_efflux
                                                             )),
                                                    x = 0.4,
                                                    y = -1+c(4,3.5,3))]
  labl.FigRanitidineFrecabHist <- caco2.perchem[casrn == "66357-35-5",.(labl = c(
    paste0("Mean: ",signif(mrec_ab,2)),
    paste0("SD: ", signif(sdrec_ab,2)),
     paste0("Total Count: ", ntotal_recab
                                                              )),
                                                     x = 1.1,
                                                     y = c(7,6,5))]
  labl.FigRanitidineFrecbaHist <- caco2.perchem[casrn == "66357-35-5",.(labl = c(
    paste0("Mean: ",signif(mrec_ba,2)),
    paste0("SD: ", signif(sdrec_ba,2)),
    paste0("Total Count: ", ntotal_recba
                                                              )),
                                                     x = 1.1,
                                                     y = c(10,8,6))]
  
  FigRanitidinePabAdjHist <- ggplot(caco2.publish[casrn == " 66357-35-5",])+
    geom_histogram(aes(x = Pab), fill= "grey80", color = "black")+
    geom_text(data = labl.dtFigRanitidinePabAdjHist, 
              aes(x = x, y= y, label = labl), hjust = 0)+
    labs(title = "Ranitidine",
         y = expression(bold("Count")), 
         x = expression(bolditalic("P"["app"]^"AB")~bold('(10'^'-6'~'cm/s)'))) +
    scale_x_log10(labels=scientific_10,limits=c(10^-2,10^0))+
    scale_y_continuous(breaks = c(0,5,10), labels = c(0,5,10), limits = c(0,10))+
    theme_bw()+
    gtheme
  print(FigRanitidinePabAdjHist)
  
  FigRanitidinePabUnadjHist <- ggplot(caco2.publish[casrn == " 66357-35-5",])+
    geom_histogram(aes(x = Pab0), fill= "grey80", color = "black")+
    geom_text(data = labl.dtFigRanitidinePabUnadjHist, 
              aes(x = x, y= y, label = labl), hjust = 0)+
    labs(title = "Ranitidine",
         y = expression(bold("Count")), 
         x = expression(bolditalic("P"["app"]^"AB")~bold('(10'^'-6'~'cm/s)'))) +
    scale_x_log10(labels=scientific_10,limits=c(10^-2,10^0))+
    theme_bw()+
    gtheme
  print(FigRanitidinePabUnadjHist)
  
  FigRanitidinePbaAdjHist <- ggplot(caco2.publish[casrn == " 66357-35-5",])+
    geom_histogram(aes(x = Pba), fill= "grey80", color = "black")+
    geom_text(data = labl.FigRanitidinePbaAdjHist, 
              aes(x = x, y= y, label = labl), hjust = 0)+
    labs(title = "Ranitidine",
         y = expression(bold("Count")), 
         x = expression(bolditalic("P"["app"]^"BA")~bold('(10'^'-6'~'cm/s)'))) +
    scale_x_log10(labels=scientific_10,limits=c(10^-1,10^2))+
    theme_bw()+
    gtheme
  
  FigRanitidinePbaUnadjHist <- ggplot(caco2.publish[casrn == " 66357-35-5",])+
    geom_histogram(aes(x = Pba0), fill= "grey80", color = "black")+
    labs(title = "Ranitidine",
         y = expression(bold("Count")), 
         x = expression(bolditalic("P"["app"]^"BA")~bold('(10'^'-6'~'cm/s)'))) +
    scale_x_log10(labels=scientific_10,limits=c(10^-1,10^2))+
    theme_bw()+
    gtheme
  
  FigRanitidineEffluxRAdjHist <- 
    ggplot(caco2.publish[casrn == " 66357-35-5",])+
    geom_histogram(aes(x = log10(efflux.ratio)), fill= "grey80", color = "black")+
    geom_text(data = labl.FigRanitidineEffluxRAdjHist, 
              aes(x = x, y= y, label = labl), hjust = 0)+
    labs(title = "Ranitidine",
         y = expression(bold("Count")), 
         x = expression(bold("Efflux Ratio"))) +
    #lims(x = c(0.75,2.25))+
    scale_x_log10(labels=scientific_10)+
    theme_bw()+
    gtheme
  
  FigRanitidineFrecabHist <- 
    ggplot(caco2.publish[casrn == " 66357-35-5",])+
    geom_histogram(aes(x = rec_ab), fill= "grey80", color = "black")+
    geom_text(data = labl.FigRanitidineFrecabHist, 
              aes(x = x, y= y, label = labl), hjust = 0)+
    labs(title = "Ranitidine",
         y = expression(bold("Count")), 
         x = expression(bolditalic("F")[bolditalic("rec")]^bolditalic("AB"))) +
    lims(x = c(0,2.2))+
    scale_y_continuous(breaks = c(0,5,10))+
    theme_bw()+
    gtheme
  
  FigRanitidineFrecbaHist  <- 
    ggplot(caco2.publish[casrn == " 66357-35-5",])+
    geom_histogram(aes(x = rec_ba), fill= "grey80", color = "black")+
    geom_text(data = labl.FigRanitidineFrecbaHist, 
              aes(x = x, y= y, label = labl), hjust = 0)+
    labs(title = "Ranitidine",
         y = expression(bold("Count")), 
         x = expression(bolditalic("F")[bolditalic("rec")]^bolditalic("BA"))) +
    lims(x = c(0,2.2))+
    theme_bw()+
    gtheme

  FigRanitidineEffluxRUnadjHist  <- ggplot(caco2.publish[casrn == " 66357-35-5",])+
    geom_histogram(aes(x = efflux0), fill= "grey80", color = "black")+
    labs(title = "Ranitidine",
         y = expression(bold("Count")), 
         x = expression(bold("Efflux Ratio"))) +
    #lims(x = c(0.75,2.25))+
    scale_x_log10(labels=scientific_10)+
    theme_bw()+
    gtheme
  
  ggsave(FigRanitidinePabAdjHist, file = paste0(loc.wd,
    "/results_for_paper/Fig_Ranitidine_Pab_histo.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
  ggsave(FigRanitidinePbaAdjHist, file = paste0(loc.wd,
    "/results_for_paper/Fig_Ranitidine_Pba_histo.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
  ggsave(FigRanitidineEffluxRAdjHist, file = paste0(loc.wd,
    "/results_for_paper/Fig_Ranitidine_efflux_histo.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
  ggsave(FigRanitidineFrecabHist, file = paste0(loc.wd,
    "/results_for_paper/Fig_Ranitidine_recab_histo.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
  ggsave(FigRanitidineFrecbaHist, file = paste0(loc.wd,
    "/results_for_paper/Fig_Ranitidine_recba_histo.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
  ggsave(FigRanitidinePabUnadjHist, file = paste0(loc.wd,
    "/results_for_paper/Fig_Ranitidine_Pab0_histo.tiff"),
    height = 3, width = 3, dpi = 600, compression = "lzw")
  # ggsave(g4b, file = paste0(loc.wd, "/results_for_paper/Ranitidine_Pba0_histo.tiff"),
  #        height = 3, width = 3, dpi = 600, compression = "lzw")
  # ggsave(g4c, file = paste0(loc.wd, "/results_for_paper/Ranitidine_efflux0_histo.tiff"),
  #        height = 3, width = 3, dpi = 600, compression = "lzw")
```  

```{r multipanelrefchemdatafigureforpaper}
ggarrange(FigWarfarinPabAdjHist, FigTalinololEffluxRAdjHist, FigRanitidinePabAdjHist, 
          labels = c("A", "B", "C"),
          ncol = 1, nrow = 3,
          common.legend = TRUE, legend = "bottom")
tiff(file = paste0(loc.wd, "/results_for_paper/Fig_RefChemsforPaper.tiff"),
         height = 3*200, width = 3*200, compression = "lzw")
ggarrange(FigWarfarinPabAdjHist, FigTalinololEffluxRAdjHist, FigRanitidinePabAdjHist, 
          labels = c("A", "B", "C"),
          ncol = 1, nrow = 3,
          common.legend = TRUE, legend = "bottom"+
          theme_gray(base_size = 100))
dev.off()
```

```{r multipanelrefchemdatasupfigures}
ggarrange(FigWarfarinPbaAdjHist, FigTalinololPbaAdjHist, FigRanitidinePbaAdjHist, 
          labels = c("A", "B", "C"),
          ncol = 2, nrow = 2,
          common.legend = TRUE, legend = "bottom")
tiff(file = paste0(loc.wd, "/results_for_paper/Fig_RefChemsPba.tiff"),
         height = 3*200, width = 3*200, compression = "lzw")
ggarrange(FigWarfarinPbaAdjHist, FigTalinololPbaAdjHist, FigRanitidinePbaAdjHist, 
          labels = c("A", "B", "C"),
          ncol = 2, nrow = 2,
          common.legend = TRUE, legend = "bottom"+
          theme_gray(base_size = 100))
dev.off()

ggarrange(FigWarfarinEffluxRAdjHist, FigTalinololPabAdjHist, FigRanitidineEffluxRAdjHist, 
          labels = c("A", "B", "C"),
          ncol = 2, nrow = 2,
          common.legend = TRUE, legend = "bottom")
tiff(file = paste0(loc.wd, "/results_for_paper/Fig_RefChemsEfflux.tiff"),
         height = 3*200, width = 3*200, compression = "lzw")
ggarrange(FigWarfarinEffluxRAdjHist, FigTalinololPabAdjHist, FigRanitidineEffluxRAdjHist,  
          labels = c("A", "B", "C"),
          ncol = 2, nrow = 2,
          common.legend = TRUE, legend = "bottom"+
          theme_gray(base_size = 100))
dev.off()

ggarrange(FigWarfarinFrecabHist, FigTalinololFrecabHist, FigRanitidineFrecabHist, 
          labels = c("A", "B", "C"),
          ncol = 2, nrow = 2,
          common.legend = TRUE, legend = "bottom")
tiff(file = paste0(loc.wd, "/results_for_paper/Fig_RefChemsFrecab.tiff"),
         height = 3*200, width = 3*200, compression = "lzw")
ggarrange(FigWarfarinFrecabHist, FigTalinololFrecabHist, FigRanitidineFrecabHist, 
          labels = c("A", "B", "C"),
          ncol = 2, nrow = 2,
          common.legend = TRUE, legend = "bottom"+
          theme_gray(base_size = 100))
dev.off()

ggarrange(FigWarfarinFrecbaHist, FigTalinololFrecbaHist, FigRanitidineFrecbaHist, 
          labels = c("A", "B", "C"),
          ncol = 2, nrow = 2,
          common.legend = TRUE, legend = "bottom")
tiff(file = paste0(loc.wd, "/results_for_paper/Fig_RefChemsFrecba.tiff"),
         height = 3*200, width = 3*200, compression = "lzw")
ggarrange(FigWarfarinFrecbaHist, FigTalinololFrecbaHist, FigRanitidineFrecbaHist, 
          labels = c("A", "B", "C"),
          ncol = 2, nrow = 2,
          common.legend = TRUE, legend = "bottom"+
          theme_gray(base_size = 100))
dev.off()
```
### Permeability histograms
```{r permeability}
# load caco2.perchem:
  load(file = paste0(loc.wd, "/r_data/processed/MeanChemicalMeasurements.RData"))

   pharma <- read_excel(
     paste0(loc.wd, "/r_data/chemical_lists/DSSTox_PHRMPEND_20170531.xlsx"))

caco2.perchem$class <- "Other"
caco2.perchem[caco2.perchem$dtxsid %in% pharma$DSSTox_Substance_Id,
              "class"] <- "Pharmaceutical"

  labl.dt1 <- data.table(x = 0.01, y = 100,
                      labl = paste0("Total Count: ",
                                    caco2.perchem[,.N,.(x1 = !is.na(mPab))][
                                      x1 == TRUE, N]))
  
  # Pab chems - 310
  labl.dt2 <- data.table(x = 0.01, y= 100,
                      labl = paste0("Total Count: ",
                                    caco2.perchem[,.N,.(x1 = !is.na(mPba))][
                                      x1 == TRUE, N])) 
  # Pba chems - 396
  
  labl.dt3 <- data.table(x = 0.01, y = 30,
                        labl = paste0("Total Count: ",
                                      caco2.perchem[,.N,.(x1 = !is.na(mPab) &
                                                            !is.na(mPba))][
                                                              x1 == TRUE, N])) 
  # efflux chems - 306
  min(caco2.perchem[,.(mPab,mPba,mPab0,mPba0)], na.rm = T)
  max(caco2.perchem[,.(mPab,mPba,mPab0,mPba0)], na.rm = T)
  
  FigPabAdjHist <- ggplot(caco2.perchem)+
        geom_histogram(aes(x = mPab, fill=class), 
                   color = "black",
                   alpha=0.4, position="identity")+
   # geom_histogram(aes(x = mPab), fill= "grey80", color = "black")+
    geom_text(data = labl.dt1, aes(x=x, y=y, label = labl), hjust = 0)+
    labs(y = expression(bold("Count")), 
         x = expression(bolditalic("P"["app"]^"AB")~bold('(10'^'-6'~'cm/s)'))) +
 #   lims(y = c(0, 140))+
    scale_x_log10(labels=scientific_10,limits=c(10^-3.5,10^2.5))+
    theme_bw()+
    gtheme+
        scale_fill_viridis(discrete=2)#+
   # annotation_custom(grob = text_grob("a)", hjust = 0, size = 12, face = "bold"), 
   #                   ymin = 130,ymax = 130,xmax = -3, xmin = -3)
  
  FigPbaAdjHist <- ggplot(caco2.perchem)+
        geom_histogram(aes(x = mPba, fill=class), 
                   color = "black",
                   alpha=0.4, position="identity")+
 #   geom_histogram(aes(x = mPba), fill= "grey80", color = "black")+
    geom_text(data = labl.dt2, aes(x=x, y=y, label = labl), hjust = 0)+
    labs(y = expression(bold("Count")), 
         x = expression(bolditalic("P"["app"]^"BA")~bold('(10'^'-6'~'cm/s)'))) +
#    lims(y = c(0, 140))+
    scale_x_log10(labels=scientific_10,limits=c(10^-3.5,10^2.5))+
    theme_bw()+
    gtheme+
        scale_fill_viridis(discrete=2)#+
#    annotation_custom(grob = text_grob("b)", hjust = 0, size = 12, face = "bold"), 
#                      ymin = 130,ymax = 130,xmax = -3, xmin = -3)
  
  FigEffluxRAdjHist <- ggplot(caco2.perchem)+
        geom_histogram(aes(x = mefflux, fill=class), 
                   color = "black",
                   alpha=0.4, position="identity")+
    #    geom_histogram(aes(x = mefflux), fill= "grey80", color = "black")+
    geom_text(data = labl.dt3, aes(x=x, y=y, label = labl), hjust = 0)+
    labs(y = expression(bold("Count")), 
         x = expression(bold("Efflux Ratio"))) +
    theme_bw()+
    scale_x_log10(labels=scientific_10)+
    geom_vline(xintercept =1,linetype="dashed",color="blue")+
    gtheme+
        scale_fill_viridis(discrete=2)#+
#    annotation_custom(grob = text_grob("c)", hjust = 0, size = 12, face = "bold"), 
#                      ymin = 28,ymax = 28,xmax = -3, xmin = -3)
  
  FigPabUnadjHist <- ggplot(caco2.perchem)+
        geom_histogram(aes(x = mPab0, fill=class), 
                   color = "black",
                   alpha=0.4, position="identity")+
  #  geom_histogram(aes(x = mPab0), fill= "grey80", color = "black")+
    labs(y = expression(bold("Count")), 
         x = expression(bolditalic("P"["app"]^"AB")~bold('(10'^'-6'~'cm/s)'))) +
 #   lims(y = c(0, 140))+
    scale_x_log10(labels=scientific_10,limits=c(10^-3.5,10^2.5))+
    theme_bw()+
        scale_fill_viridis(discrete=2)+
    gtheme
  
  FigPbaUnadjHist <- ggplot(caco2.perchem)+
        geom_histogram(aes(x = mPba0, fill=class), 
                   color = "black",
                   alpha=0.4, position="identity")+
  #  geom_histogram(aes(x = mPba0), fill= "grey80", color = "black")+
    labs(y = expression(bold("Count")), 
         x = expression(bolditalic("P"["app"]^"BA")~bold('(10'^'-6'~'cm/s)'))) +
 #   lims(y = c(0, 140))+
    scale_x_log10(labels=scientific_10,limits=c(10^-3.5,10^2.5))+
    theme_bw()+
        scale_fill_viridis(discrete=2)+
    gtheme
  
  FigEffluxRUnadjHist <- ggplot(caco2.perchem)+
        geom_histogram(aes(x = mefflux0, fill=class), 
                   color = "black",
                   alpha=0.4, position="identity")+
    #geom_histogram(aes(x = mefflux0), fill= "grey80", color = "black")+
    labs(y = expression(bold("Count")), 
         x = expression(bold("Efflux Ratio"))) +
    scale_x_log10(labels=scientific_10)+
    theme_bw()+
        scale_fill_viridis(discrete=2)+
    gtheme

  ggsave(FigPabAdjHist, file = paste0(loc.wd, "/results_for_paper/Fig_mPab_histo.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
  ggsave(FigPbaAdjHist, file = paste0(loc.wd, "/results_for_paper/Fig_mPba_histo.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
  ggsave(FigEffluxRAdjHist, file = paste0(loc.wd, "/results_for_paper/Fig_mefflux_histo.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
  
  ggsave(FigPabUnadjHist, file = paste0(loc.wd, "/results_for_paper/Fig_mPab0_histo.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
  ggsave(FigPbaUnadjHist, file = paste0(loc.wd, "/results_for_paper/Fig_mPba0_histo.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
  ggsave(FigEffluxRUnadjHist, file = paste0(loc.wd, "/results_for_paper/Fig_mefflux0_histo.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
  print(FigPabAdjHist)
  print(FigPabUnadjHist)
```
```{r multipaneltestchemdatafigureforpaper}
ggarrange(FigPabAdjHist, FigPbaAdjHist, FigEffluxRAdjHist, 
          labels = c("A", "B", "C"),
          ncol = 1, nrow = 3,
          common.legend = TRUE, legend = "bottom")
tiff(file = paste0(loc.wd, "/results_for_paper/Fig_CacoDataHists.tiff"),
         height = 5*200, width = 3*200, compression = "lzw")
ggarrange(FigPabAdjHist, FigPbaAdjHist, FigEffluxRAdjHist, 
          labels = c("A", "B", "C"),
          ncol = 1, nrow = 3,
          common.legend = TRUE, legend = "bottom"+
          theme_gray(base_size = 100))
dev.off()
```

```{r chemclasshistogram,eval=FALSE}
   pharma <- read_excel(
     paste0(loc.wd, "/r_data/chemical_lists/DSSTox_PHRMPEND_20170531.xlsx"))

caco2.perchem$class <- "Other"
caco2.perchem[caco2.perchem$dtxsid %in% pharma$DSSTox_Substance_Id,
              "class"] <- "Pharmaceutical"

  FigPabAdjClassHist <- ggplot(caco2.perchem)+
    geom_histogram(aes(x = mPab, fill=class), 
                   color = "black",
                   alpha=0.2, position="identity")+
    geom_text(data = labl.dt1, aes(x=x, y=y, label = labl), hjust = 0)+
    labs(y = expression(bold("Count")), 
         x = expression(bolditalic("P"["app"]^"AB")~bold('(10'^'-6'~'cm/s)'))) +
    lims(y = c(0, 140))+
    scale_x_log10(labels=scientific_10,limits=c(10^-3.5,10^2.5))+
    theme_bw()+
    gtheme+
    scale_fill_viridis(discrete=2)+
    annotation_custom(grob = text_grob("a)", hjust = 0, size = 12, face = "bold"), 
                      ymin = 130,ymax = 130,xmax = -3, xmin = -3)

    ggsave(FigPabAdjClassHist, file = paste0(loc.wd, "/results_for_paper/f2a_mPab_class_histo.tiff"),
         height = 3, width = 3, dpi = 600, compression = "lzw")
    print(FigPabAdjClassHist)

```

Consider practical implications of Yu and Amidon (1999) Equation 11:
```{r fabdistribution}
# Human fabs factor (s/cm 10^-4):
human.fabs.factor <- 2*199.2/1.75/7*60/10^4

# Yu and Amidon (1999) Equation 11:
# here Peff has units of 10^-4 cm / s
Fabs <- function(Peff, factor=human.fabs.factor){return(1-(1+factor*Peff)^-7)}

# Yu and Amidon (1999) Ketoprofen has Peff = 3.06*10^4/60/60 cm 10^-4/s
# should give Fabs close to 100%:
Fabs(Peff=3.06*10^4/60/60)

# Yu and Amidon (1999) Enalaprilat has Peff = 0.079*10^4/60/60 cm 10^-4/s
# should give Fabs close to 10%:
Fabs(Peff=0.079*10^4/60/60)

Fabs(Peff=0.53)
# Peff <= 0.53 cm 10^-4 / s needed for Human Fabs <= 0.5

# Yang 2007 equation 10 for Caco2 pH7.4
Peff <- function(Caco2.Pab) {return(10^(0.4926 * log10(Caco2.Pab) - 0.1454))}
Peff(Caco2.Pab=0.55)

# Caco2.Pab <= 0.55 10^-6 cm / s needed for Human Peff <= 0.53
Fabs(Peff=Peff(Caco2.Pab=0.55))
Caco2.Pab.thresh.human <- 0.55
cat(paste0("As a consequence of Equations 5 and 7, ",
           "for humans we need to observe PappAB <= ",
           Caco2.Pab.thresh.human,
           " 10^-6 cm /s to predict Fabs <= 0.5.\n"))

# Caco2.Pab <= 0.55 for Human Fabs <= 0.5
cat(paste0("Only ",
           sum(subset(caco2.perchem,!is.na(mPab))$mPab < Caco2.Pab.thresh.human),
           " chemicals (",
           100*signif(sum(subset(caco2.perchem,!is.na(mPab))$mPab < 
                            Caco2.Pab.thresh.human) /
                        dim(subset(caco2.perchem,!is.na(mPab)))[1],2),
           "%) have measured Pappab indicating Fabs < 0.5 for humans.\n"))

# Rat fabs factor (s/cm 10^-4):
rat.fabs.factor <- 2*88/0.18/7*60/10^4

peff.human <- Peff(Caco2.Pab=2.4)
# Wahajudin (2011) Peff.human -> Peff.rat for Peff.human = 0:
Peff.rat <- (peff.human+.1815)/1.039/10
Fabs(Peff=Peff.rat, factor=rat.fabs.factor)
Caco2.Pab.thresh.rat <- 2.4

# Caco2.Pab <= 0.55 for Human Fabs <= 0.5
cat(paste0(sum(subset(caco2.perchem,!is.na(mPab))$mPab < Caco2.Pab.thresh.rat),
           " chemicals (",
           100*signif(sum(subset(caco2.perchem,!is.na(mPab))$mPab < 
                            Caco2.Pab.thresh.rat) /
                        dim(subset(caco2.perchem,!is.na(mPab)))[1],2),
           "%) have measured Pappab indicating Fabs < 0.5 for rats. ",
           "That is, rats are predicted to absorb some of these chemicals less ",
           "effectively than humans.\n"))
```
